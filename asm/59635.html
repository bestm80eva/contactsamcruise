<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Contact Sam Cruise: Routine at 59635</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../csc.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="Contact Sam Cruise" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="59632.html">59632</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#59635">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="59839.html">59839</a></span></td>
</tr>
</table>
<div class="description">59635: Superimpose sprite tiles onto a tile of the play area</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a class="link" href="59148.html">59148</a>. If any part of a character's sprite needs to be printed at the row and column specified by <span class="register">DE'</span>, the appropriate tile is located and superimposed onto the contents of the buffer at <a class="link" href="40990.html">40990</a>.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">A</td>
<td class="register-desc">2</td>
</tr>
<tr>
<td class="register">D'</td>
<td class="register-desc">Play area y-coordinate</td>
</tr>
<tr>
<td class="register">E'</td>
<td class="register-desc">Play area x-coordinate</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59635"></a>59635</td>
<td class="instruction">CALL 59640</td>
<td class="comment-11" rowspan="1">Superimpose sprite tiles for characters whose z-coordinate is 2 (between a building and the sidewalk)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59638"></a>59638</td>
<td class="instruction">LD A,4</td>
<td class="comment-11" rowspan="1">Prepare to superimpose sprite tiles for characters whose z-coordinate is 4 (on the sidewalk or road)</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="59640"></a>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a class="link" href="59148.html">59148</a> with <span class="register">A</span>=1 (to superimpose sprite tiles for characters who are indoors).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59640"></a>59640</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59641"></a>59641</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1"><span class="register">C'</span>=1 (indoors), 2 (between buildings and the sidewalk) or 4 (on the sidewalk or road)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59642"></a>59642</td>
<td class="instruction">LD H,215</td>
<td class="comment-11" rowspan="1">215 is the first character</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59644"></a>59644</td>
<td class="instruction">LD L,4</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL'</span> at byte 4 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59646"></a>59646</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character's z-coordinate (1, 2, 4 or 8)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59647"></a>59647</td>
<td class="instruction">AND C</td>
<td class="comment-11" rowspan="1">Reset the zero flag if the character's sprite should be printed</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="59648"></a>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a class="link" href="26002.html">26002</a> with <span class="register">H</span>=230 (Sam), <span class="register">DE</span> holding the play area coordinates of a bullet, and the zero flag reset unless Sam's indoors.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59648"></a>59648</td>
<td class="instruction">JR Z,59742</td>
<td class="comment-11" rowspan="1">Consider the next character if this one should not be printed</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59650"></a>59650</td>
<td class="instruction">LD L,0</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL'</span> at byte 0 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59652"></a>59652</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character's animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59653"></a>59653</td>
<td class="instruction">AND 127</td>
<td class="comment-11" rowspan="1">Drop the direction bit (bit 7)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59655"></a>59655</td>
<td class="instruction">CP 120</td>
<td class="comment-11" rowspan="1">Is this character's animatory state &gt;= 120?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59657"></a>59657</td>
<td class="instruction">JR NC,59717</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="59659"></a>
<div class="comments">
<div class="paragraph">
The character's animatory state is &lt; 120, which means he has a 5x3 sprite.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59659"></a>59659</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1"><span class="register">L'</span>=1</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59660"></a>59660</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character's animatory state + 1</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59661"></a>59661</td>
<td class="instruction">AND 7</td>
<td class="comment-11" rowspan="1">Reduce this modulo 8</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59663"></a>59663</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=X, the play area x-coordinate (0-255)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59664"></a>59664</td>
<td class="instruction">JR Z,59692</td>
<td class="comment-11" rowspan="1">Jump if the character's animatory state is congruent to 7 mod 8</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="59666"></a>
<div class="comments">
<div class="paragraph">
The character's animatory state is congruent to 0-6 mod 8, which means he has a sprite with 5 rows and 3 columns. Check whether any part of the sprite impinges on the tile at (X,Y).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59666"></a>59666</td>
<td class="instruction">SUB (HL)</td>
<td class="comment-11" rowspan="1">Subtract the character's x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59667"></a>59667</td>
<td class="instruction">CP 3</td>
<td class="comment-11" rowspan="1">Does any part of the sprite impinge on column X?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59669"></a>59669</td>
<td class="instruction">JR NC,59742</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59671"></a>59671</td>
<td class="instruction">DEC L</td>
<td class="comment-11" rowspan="1"><span class="register">L'</span>=0</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59672"></a>59672</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-11" rowspan="1">Is the character facing left?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59674"></a>59674</td>
<td class="instruction">JR Z,59679</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59676"></a>59676</td>
<td class="instruction">CPL</td>
<td class="comment-11" rowspan="2">Set <span class="register">A</span> to 2-<span class="register">A</span> if the character is facing right</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59677"></a>59677</td>
<td class="instruction">ADD A,3</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59679"></a>59679</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1"><span class="register">B'</span>=0, 1 or 2 (the column of the character's sprite at (X,Y))</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59680"></a>59680</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="3"><span class="register">A</span>=5*<span class="register">B</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59681"></a>59681</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59682"></a>59682</td>
<td class="instruction">ADD A,B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59683"></a>59683</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1"><span class="register">B'</span>=0, 5 or 10</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59684"></a>59684</td>
<td class="instruction">LD L,2</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL'</span> at byte 2 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59686"></a>59686</td>
<td class="instruction">LD A,D</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=Y, the play area y-coordinate (2-39)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59687"></a>59687</td>
<td class="instruction">SUB (HL)</td>
<td class="comment-11" rowspan="1">Subtract the character's y-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59688"></a>59688</td>
<td class="instruction">CP 5</td>
<td class="comment-11" rowspan="1">Set the carry flag if the sprite impinges on row Y</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59690"></a>59690</td>
<td class="instruction">JR 59740</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="59692"></a>
<div class="comments">
<div class="paragraph">
The character's animatory state is congruent to 7 mod 8, which means he has a sprite with 3 rows and 5 columns. Check whether any part of the sprite impinges on the tile at (X,Y).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59692"></a>59692</td>
<td class="instruction">SUB (HL)</td>
<td class="comment-11" rowspan="1">Subtract the character's x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59693"></a>59693</td>
<td class="instruction">CP 5</td>
<td class="comment-11" rowspan="1">Does any part of the character impinge on column X?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59695"></a>59695</td>
<td class="instruction">JR NC,59742</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59697"></a>59697</td>
<td class="instruction">DEC L</td>
<td class="comment-11" rowspan="1"><span class="register">L'</span>=0</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59698"></a>59698</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-11" rowspan="1">Is the character facing left?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59700"></a>59700</td>
<td class="instruction">JR Z,59705</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59702"></a>59702</td>
<td class="instruction">CPL</td>
<td class="comment-11" rowspan="2">Set <span class="register">A</span>=4-<span class="register">A</span> if the character is facing right</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59703"></a>59703</td>
<td class="instruction">ADD A,5</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59705"></a>59705</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1"><span class="register">B'</span>=0, 1, 2, 3 or 4 (the column of the sprite at (X,Y))</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59706"></a>59706</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="2"><span class="register">A</span>=3*<span class="register">B'</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59707"></a>59707</td>
<td class="instruction">ADD A,B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59708"></a>59708</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1"><span class="register">B'</span>=0, 3, 6, 9 or 12</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59709"></a>59709</td>
<td class="instruction">LD L,2</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL'</span> at byte 2 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59711"></a>59711</td>
<td class="instruction">LD A,D</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=Y, the play area y-coordinate (2-39)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59712"></a>59712</td>
<td class="instruction">SUB (HL)</td>
<td class="comment-11" rowspan="1">Subtract the character's y-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59713"></a>59713</td>
<td class="instruction">CP 3</td>
<td class="comment-11" rowspan="1">Set the carry flag if the sprite impinges on row Y</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59715"></a>59715</td>
<td class="instruction">JR 59740</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="59717"></a>
<div class="comments">
<div class="paragraph">
The character's animatory state is &gt;= 120, which means he has a sprite with 2 rows and 2 columns. Check whether any part of the sprite impinges on the tile at (X,Y).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59717"></a>59717</td>
<td class="instruction">LD L,1</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL'</span> at byte 1 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59719"></a>59719</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=X, the play area x-coordinate (0-255)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59720"></a>59720</td>
<td class="instruction">SUB (HL)</td>
<td class="comment-11" rowspan="1">Subtract the character's x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59721"></a>59721</td>
<td class="instruction">CP 2</td>
<td class="comment-11" rowspan="1">Does any part of the sprite impinge on column X?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59723"></a>59723</td>
<td class="instruction">JR NC,59742</td>
<td class="comment-11" rowspan="1">Consider the next character if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59725"></a>59725</td>
<td class="instruction">DEC L</td>
<td class="comment-11" rowspan="1"><span class="register">L'</span>=0</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59726"></a>59726</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-11" rowspan="1">Is the character facing left?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59728"></a>59728</td>
<td class="instruction">JR Z,59732</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59730"></a>59730</td>
<td class="instruction">XOR 1</td>
<td class="comment-11" rowspan="1">Set <span class="register">A</span>=1-<span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59732"></a>59732</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=0 or 2</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59733"></a>59733</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1"><span class="register">B'</span>=0 or 2</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59734"></a>59734</td>
<td class="instruction">LD L,2</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL'</span> at byte 2 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59736"></a>59736</td>
<td class="instruction">LD A,D</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=Y, the play area y-coordinate (2-39)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59737"></a>59737</td>
<td class="instruction">SUB (HL)</td>
<td class="comment-11" rowspan="1">Subtract the character's y-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59738"></a>59738</td>
<td class="instruction">CP 2</td>
<td class="comment-11" rowspan="1">Set the carry flag if the sprite impinges on row Y</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59740"></a>59740</td>
<td class="instruction">JR C,59750</td>
<td class="comment-11" rowspan="1">Jump if the sprite impinges on row Y</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59742"></a>59742</td>
<td class="instruction">INC H</td>
<td class="comment-11" rowspan="1">Next character</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59743"></a>59743</td>
<td class="instruction">LD A,H</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character number</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59744"></a>59744</td>
<td class="instruction">CP 231</td>
<td class="comment-11" rowspan="1">Have we done all the characters (215-230)?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59746"></a>59746</td>
<td class="instruction">JR NZ,59644</td>
<td class="comment-11" rowspan="1">Jump back if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59748"></a>59748</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59749"></a>59749</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="59750"></a>
<div class="comments">
<div class="paragraph">
The character's sprite impinges on the tile at coordinates (X,Y).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59750"></a>59750</td>
<td class="instruction">ADD A,B</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=0-14 (index of the sprite tile at (X,Y))</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59751"></a>59751</td>
<td class="instruction">ADD A,215</td>
<td class="comment-11" rowspan="1">215&lt;=<span class="register">A</span>&lt;=229</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59753"></a>59753</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59754"></a>59754</td>
<td class="instruction">LD H,A</td>
<td class="comment-11" rowspan="1">215&lt;=<span class="register">H</span>&lt;=229</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59755"></a>59755</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59756"></a>59756</td>
<td class="instruction">LD L,0</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL'</span> at byte 0 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59758"></a>59758</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character's animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59759"></a>59759</td>
<td class="instruction">AND 7</td>
<td class="comment-11" rowspan="1">Keep only bits 0-2</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59761"></a>59761</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character's animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59762"></a>59762</td>
<td class="instruction">JR NZ,59766</td>
<td class="comment-11" rowspan="1">Jump if the animatory state is congruent to 1-7 mod 8</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59764"></a>59764</td>
<td class="instruction">ADD A,2</td>
<td class="comment-11" rowspan="1">Add 2 if the animatory state is congruent to 0 mod 8</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59766"></a>59766</td>
<td class="instruction">OR 128</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>&gt;=129</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59768"></a>59768</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59769"></a>59769</td>
<td class="instruction">LD L,A</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>&gt;=129, 215&lt;=<span class="register">H</span>&lt;=229</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59770"></a>59770</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=sprite tile reference (0-214, 217-255)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59771"></a>59771</td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1">Copy this to <span class="register">E</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59772"></a>59772</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Set the zero flag if this is the blank tile</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59773"></a>59773</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59774"></a>59774</td>
<td class="instruction">JR Z,59742</td>
<td class="comment-11" rowspan="1">Jump back to consider the next character if the sprite tile is blank</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="59776"></a>
<div class="comments">
<div class="paragraph">
A tile of this character's sprite needs to be printed at (X,Y). The apparent intention of the next section of code is to treat animatory states <a class="link" href="../graphics/as.html#120">120-127/248-255</a> (used only by the hook) specially, but the next instruction copies <span class="register">L'</span> (which holds 0) instead of <span class="register">L</span> (which holds the adjusted animatory state) into <span class="register">A</span>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59776"></a>59776</td>
<td class="instruction">LD A,L</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=0</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59777"></a>59777</td>
<td class="instruction">CP 248</td>
<td class="comment-11" rowspan="1">This instruction sets the carry flag</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59779"></a>59779</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59780"></a>59780</td>
<td class="instruction">JR C,59791</td>
<td class="comment-11" rowspan="1">This jump is always made</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="59782"></a>
<div class="comments">
<div class="paragraph">
The next section of code is never executed.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59782"></a>59782</td>
<td class="instruction">LD H,219</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at one of the eight bytes at <a class="link" href="56312.html">56312</a> (which are all zero)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59784"></a>59784</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">Pick up the byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59785"></a>59785</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Set the zero flag</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59786"></a>59786</td>
<td class="instruction">JR Z,59791</td>
<td class="comment-11" rowspan="1">This jump would always be made</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59788"></a>59788</td>
<td class="instruction">LD (43038),A</td>
<td class="comment-11" rowspan="1">Update the attribute byte stored at <a class="link" href="43038.html">43038</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="59791"></a>
<div class="comments">
<div class="paragraph">
Normal service resumes here.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59791"></a>59791</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59792"></a>59792</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character's animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59793"></a>59793</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59794"></a>59794</td>
<td class="instruction">LD D,199</td>
<td class="comment-11" rowspan="1">Point <span class="register">DE</span> at the graphic data for the sprite tile</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59796"></a>59796</td>
<td class="instruction">LD HL,40990</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the back buffer at <a class="link" href="40990.html">40990</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59799"></a>59799</td>
<td class="instruction">RLCA</td>
<td class="comment-11" rowspan="1">Is the character facing right?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59800"></a>59800</td>
<td class="instruction">JR C,59817</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="59802"></a>
<div class="comments">
<div class="paragraph">
The character is facing left, so we can use the tile as-is (there is no need to flip it).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59802"></a>59802</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-11" rowspan="1">Now <span class="register">DE</span> points at the back buffer, and <span class="register">HL</span> points at the graphic data for the sprite tile</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59803"></a>59803</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">Pick up a graphic byte from the back buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59804"></a>59804</td>
<td class="instruction">OR (HL)</td>
<td class="comment-11" rowspan="1">OR on the sprite tile graphic byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59805"></a>59805</td>
<td class="instruction">INC H</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the sprite tile mask byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59806"></a>59806</td>
<td class="instruction">AND (HL)</td>
<td class="comment-11" rowspan="1">AND on the sprite tile mask byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59807"></a>59807</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-11" rowspan="1">Update the back buffer byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59808"></a>59808</td>
<td class="instruction">INC H</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the next graphic byte of the sprite tile</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59809"></a>59809</td>
<td class="instruction">INC D</td>
<td class="comment-11" rowspan="1">Point <span class="register">DE</span> at the next byte of the back buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59810"></a>59810</td>
<td class="instruction">BIT 3,D</td>
<td class="comment-11" rowspan="1">Have we finished all 8 bytes?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59812"></a>59812</td>
<td class="instruction">JR Z,59803</td>
<td class="comment-11" rowspan="1">Jump back if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59814"></a>59814</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-11" rowspan="1">This instruction is redundant</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59815"></a>59815</td>
<td class="instruction">JR 59836</td>
<td class="comment-11" rowspan="1">Consider the next character</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="59817"></a>
<div class="comments">
<div class="paragraph">
The character is facing right, so we need to flip the tile.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59817"></a>59817</td>
<td class="instruction">LD B,126</td>
<td class="comment-11" rowspan="1">The table of mirror bytes is in <a class="link" href="32256.html">page 126</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59819"></a>59819</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">Pick up a sprite tile graphic byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59820"></a>59820</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1">Copy it to <span class="register">C</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59821"></a>59821</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=mirror image of the sprite tile graphic byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59822"></a>59822</td>
<td class="instruction">OR (HL)</td>
<td class="comment-11" rowspan="1">OR on the back buffer graphic byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59823"></a>59823</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-11" rowspan="1">Store the result in the back buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59824"></a>59824</td>
<td class="instruction">INC D</td>
<td class="comment-11" rowspan="1">Point <span class="register">DE</span> at the sprite tile mask byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59825"></a>59825</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">Pick this up in <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59826"></a>59826</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1">Copy it to <span class="register">C</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59827"></a>59827</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=mirror image of the sprite tile mask byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59828"></a>59828</td>
<td class="instruction">AND (HL)</td>
<td class="comment-11" rowspan="1">AND on the back buffer graphic byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59829"></a>59829</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-11" rowspan="1">Store the result in the back buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59830"></a>59830</td>
<td class="instruction">INC D</td>
<td class="comment-11" rowspan="1">Point <span class="register">DE</span> at the next graphic byte of the sprite tile</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59831"></a>59831</td>
<td class="instruction">INC H</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the next byte of the back buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59832"></a>59832</td>
<td class="instruction">BIT 3,H</td>
<td class="comment-11" rowspan="1">Have we finished all 8 bytes?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59834"></a>59834</td>
<td class="instruction">JR Z,59819</td>
<td class="comment-11" rowspan="1">Jump back if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59836"></a>59836</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59837"></a>59837</td>
<td class="instruction">JR 59742</td>
<td class="comment-11" rowspan="1">Jump back to consider the next character</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="59632.html">59632</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#59635">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="59839.html">59839</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Contact Sam Cruise RAM disassembly 20150417</div>
<div class="copyright">&#169; 1986 Microsphere Computer Services Ltd (Contact Sam Cruise). &#169; 2015 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 4.3.</div>
</div>
</body>
</html>