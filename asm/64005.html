<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Contact Sam Cruise: Routine at 64005</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../microsphere.css" />
<link rel="stylesheet" type="text/css" href="../csc.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="64004.html">64004</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#64005">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="64121.html">64121</a></span></td>
</tr>
</table>
<div class="description">64005: Deal with a character who has been knocked over</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
The address of this uninterruptible subcommand routine is placed into bytes 18 and 19 of a character's buffer (by the routine at <a class="link" href="64162.html">64162</a>) when he's been hit on the head by a falling character with an x-coordinate that differs from his by 1. It controls the character from the moment he is knocked over until he has finished staggering from being dazed by the collision.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Character number (215-229)</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="64005"></a>64005</td>
<td class="instruction">LD A,138</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=10 (short knockout delay) + 128 (quick recovery)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64007"></a>64007</td>
<td class="instruction">JR 64011</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="64009"></a>
<div class="comments">
<div class="paragraph">
The address of this entry point is placed into bytes 18 and 19 of a character's buffer (by the routine at <a class="link" href="64162.html">64162</a>) when he's been hit on the head by a falling character with the same x-coordinate.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64009"></a>64009</td>
<td class="instruction">LD A,20</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=20 (long knockout delay) + 0*128 (slow recovery)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="64011"></a>64011</td>
<td class="instruction">LD L,20</td>
<td class="comment-11" rowspan="2">Initialise the character's knockout delay counter in byte 20 of his buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64013"></a>64013</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64014"></a>64014</td>
<td class="instruction">LD L,0</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 0 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64016"></a>64016</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">E</span>=character's animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64017"></a>64017</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=1</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64018"></a>64018</td>
<td class="instruction">LD D,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">D</span>=character's x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64019"></a>64019</td>
<td class="instruction">LD L,13</td>
<td class="comment-11" rowspan="2">Store the character's pre-knockout animatory state in byte 13 of his buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64021"></a>64021</td>
<td class="instruction">LD (HL),E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64022"></a>64022</td>
<td class="instruction">LD L,21</td>
<td class="comment-11" rowspan="2">Store the character's current x-coordinate in byte 21 of his buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64024"></a>64024</td>
<td class="instruction">LD (HL),D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64025"></a>64025</td>
<td class="instruction">CALL <a class="link" href="63954.html">63954</a></td>
<td class="comment-11" rowspan="1">Knock the character over</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64028"></a>64028</td>
<td class="instruction">CALL <a class="link" href="63994.html#63997">63997</a></td>
<td class="comment-11" rowspan="1">Place the address of the following instruction into bytes 18 and 19 of the character's buffer</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="64031"></a>
<div class="comments">
<div class="paragraph">
This entry point is used after the character has been knocked over and until he stands up again.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64031"></a>64031</td>
<td class="instruction">LD L,20</td>
<td class="comment-11" rowspan="1">Byte 20 of the character's buffer holds the knockout delay counter</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64033"></a>64033</td>
<td class="instruction">DEC (HL)</td>
<td class="comment-11" rowspan="1">Decrement it</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64034"></a>64034</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">Pick up the current value in <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64035"></a>64035</td>
<td class="instruction">AND 127</td>
<td class="comment-11" rowspan="1">Is it time for the character to stand up?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64037"></a>64037</td>
<td class="instruction">RET NZ</td>
<td class="comment-11" rowspan="1">Return if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64038"></a>64038</td>
<td class="instruction">LD A,L</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=20</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64039"></a>64039</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-11" rowspan="1">Is bit 7 of the knockout delay counter set?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64041"></a>64041</td>
<td class="instruction">JR NZ,64044</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64043"></a>64043</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=40</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="64044"></a>64044</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-11" rowspan="1">Initialise the recovery delay counter (in byte 20 of the character's buffer) to 40 (if the character was hit by another with the same x-coordinate) or 20</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64045"></a>64045</td>
<td class="instruction">CALL <a class="link" href="60293.html#60300">60300</a></td>
<td class="comment-11" rowspan="1">Make the character stand up</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64048"></a>64048</td>
<td class="instruction">CALL <a class="link" href="63994.html#63997">63997</a></td>
<td class="comment-11" rowspan="1">Place the address of the following instruction (64051) into bytes 18 and 19 of the character's buffer</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="64051"></a>
<div class="comments">
<div class="paragraph">
This entry point is used after the character has stood up again and while he is still dazed from the collision.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64051"></a>64051</td>
<td class="instruction">LD L,20</td>
<td class="comment-11" rowspan="2">Decrement the recovery delay counter</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64053"></a>64053</td>
<td class="instruction">DEC (HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64054"></a>64054</td>
<td class="instruction">JR Z,<a class="link" href="64131.html">64131</a></td>
<td class="comment-11" rowspan="1">Jump if it has reached 0</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64056"></a>64056</td>
<td class="instruction">LD L,0</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 0 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64058"></a>64058</td>
<td class="instruction">BIT 0,(HL)</td>
<td class="comment-11" rowspan="1">Is the character facing right?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64060"></a>64060</td>
<td class="instruction">JR NZ,64075</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64062"></a>64062</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">Save the character number briefly</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64063"></a>64063</td>
<td class="instruction">CALL <a class="link" href="60179.html">60179</a></td>
<td class="comment-11" rowspan="1">Obtain descriptors for the character's current location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64066"></a>64066</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Restore the character number to <span class="register">H</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64067"></a>64067</td>
<td class="instruction">BIT 7,C</td>
<td class="comment-11" rowspan="1">Can the character move left?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64069"></a>64069</td>
<td class="instruction">JR Z,64080</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64071"></a>64071</td>
<td class="instruction">BIT 6,C</td>
<td class="comment-11" rowspan="1">Can the character move right?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64073"></a>64073</td>
<td class="instruction">JR Z,64080</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="64075"></a>64075</td>
<td class="instruction">CALL <a class="link" href="61823.html">61823</a></td>
<td class="comment-11" rowspan="1">Get a random number in <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64078"></a>64078</td>
<td class="instruction">RRCA</td>
<td class="comment-11" rowspan="1">Rotate bit 0 into bit 7 for no apparent reason</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64079"></a>64079</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1">Bit 7 of <span class="register">C</span> will be used to decide whether the character should move left next</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="64080"></a>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a class="link" href="64131.html">64131</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="64080"></a>64080</td>
<td class="instruction">LD DE,59861</td>
<td class="comment-11" rowspan="2">Load the address of the routine at <a class="link" href="59861.html">59861</a> onto the stack</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64083"></a>64083</td>
<td class="instruction">PUSH DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64084"></a>64084</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">Save the direction descriptor (in <span class="register">C</span>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64085"></a>64085</td>
<td class="instruction">CALL <a class="link" href="59848.html">59848</a></td>
<td class="comment-11" rowspan="1">Update the SRB for the character's current animatory state and location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64088"></a>64088</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1">Restore the direction descriptor to <span class="register">C</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64089"></a>64089</td>
<td class="instruction">RLC C</td>
<td class="comment-11" rowspan="1">Set the carry flag if the character is going to move left</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64091"></a>64091</td>
<td class="instruction">BIT 7,A</td>
<td class="comment-11" rowspan="1">Is the character facing right?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64093"></a>64093</td>
<td class="instruction">JR NZ,64109</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="64095"></a>
<div class="comments">
<div class="paragraph">
The character is facing left.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64095"></a>64095</td>
<td class="instruction">JR NC,64111</td>
<td class="comment-11" rowspan="1">Jump if the character is going to move right (take a step backwards)</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="64097"></a>
<div class="comments">
<div class="paragraph">
The character is going to take a step forwards.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="64097"></a>64097</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character's next animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64098"></a>64098</td>
<td class="instruction">BIT 0,A</td>
<td class="comment-11" rowspan="1">Is it midstride?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64100"></a>64100</td>
<td class="instruction">RET NZ</td>
<td class="comment-11" rowspan="1">Return (to <a class="link" href="59861.html">59861</a>) if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="64101"></a>
<div class="comments">
<div class="paragraph">
The character has just moved from the midstride position. Adjust his x-coordinate as appropriate.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="64101"></a>64101</td>
<td class="instruction">DEC E</td>
<td class="comment-11" rowspan="1"><span class="register">E</span>=x-1 (where x is the character's x-coordinate)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64102"></a>64102</td>
<td class="instruction">JR C,64106</td>
<td class="comment-11" rowspan="1">Jump if the character is moving left</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64104"></a>64104</td>
<td class="instruction">INC E</td>
<td class="comment-11" rowspan="2"><span class="register">E</span>=x+1 (the character is moving right)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64105"></a>64105</td>
<td class="instruction">INC E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="64106"></a>64106</td>
<td class="instruction">AND 251</td>
<td class="comment-11" rowspan="1">Make sure that bit 2 of the character's animatory state is reset</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64108"></a>64108</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">To <a class="link" href="59861.html">59861</a>, to update the character's animatory state and location and update the SRB</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="64109"></a>
<div class="comments">
<div class="paragraph">
The character is facing right.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="64109"></a>64109</td>
<td class="instruction">JR NC,64097</td>
<td class="comment-11" rowspan="1">Jump if the character is going to move right (take a step forwards)</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="64111"></a>
<div class="comments">
<div class="paragraph">
The character is going to take a step backwards.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="64111"></a>64111</td>
<td class="instruction">DEC A</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character's next animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64112"></a>64112</td>
<td class="instruction">BIT 0,A</td>
<td class="comment-11" rowspan="1">Is it midstride?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64114"></a>64114</td>
<td class="instruction">RET Z</td>
<td class="comment-11" rowspan="1">Return (to <a class="link" href="59861.html">59861</a>) if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64115"></a>64115</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="4">Add 4 to <span class="register">A</span> (without affecting the carry flag) to obtain the correct midstride animatory state (though bit 2 may need to be reset)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64116"></a>64116</td>
<td class="instruction">INC A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64117"></a>64117</td>
<td class="instruction">INC A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64118"></a>64118</td>
<td class="instruction">INC A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="64119"></a>64119</td>
<td class="instruction">JR 64101</td>
<td class="comment-11" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="64004.html">64004</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#64005">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="64121.html">64121</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Contact Sam Cruise RAM disassembly 20140614</div>
<div class="copyright">&#169; 1986 Microsphere Computer Services Ltd (Contact Sam Cruise). &#169; 2014 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://pyskool.ca/?page_id=177">SkoolKit</a> 4.0.</div>
</div>
</body>
</html>