<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Contact Sam Cruise: Routine at 63838</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../csc.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="Contact Sam Cruise" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="63837.html">63837</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#63838">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="63953.html">63953</a></span></td>
</tr>
</table>
<div class="description">63838: Change Sam's disguise</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Continues from the routine at <a class="link" href="64218.html">64218</a>. Replaces certain sprite tiles that are used by Sam's animatory states (thus changing his appearance), and then draws Sam's new disguise in the bottom right corner of the screen.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">230 (Sam)</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="63838"></a>63838</td>
<td class="instruction">LD L,8</td>
<td class="comment-11" rowspan="2">Set Sam's main action timer (in byte 8 of his buffer) to 8</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63840"></a>63840</td>
<td class="instruction">LD (HL),L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63841"></a>63841</td>
<td class="instruction">LD HL,32713</td>
<td class="comment-11" rowspan="1"><a class="link" href="32713.html">32713</a> holds Sam's current disguise ID</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63844"></a>63844</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">Pick this up in <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63845"></a>63845</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="2"><span class="register">A</span>=next disguise ID (0-7)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63846"></a>63846</td>
<td class="instruction">AND 7</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63848"></a>63848</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-11" rowspan="1">Store the new disguise ID</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="63849"></a>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a class="link" href="30989.html">30989</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="63849"></a>63849</td>
<td class="instruction">CALL <a class="link" href="32009.html#32010">32010</a></td>
<td class="comment-11" rowspan="1">Set the attribute bytes for Sam's current disguise</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63852"></a>63852</td>
<td class="instruction">LD A,(32713)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=Sam's disguise ID (0-7)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63855"></a>63855</td>
<td class="instruction">ADD A,223</td>
<td class="comment-11" rowspan="3">Point <span class="register">BC</span> at the reference for the first replacement tile (in the data table at <a class="link" href="57150.html">57150</a>, <a class="link" href="57406.html">57406</a>, <a class="link" href="57662.html">57662</a>, <a class="link" href="57918.html">57918</a>, <a class="link" href="58174.html">58174</a>, <a class="link" href="58430.html">58430</a>, <a class="link" href="58686.html">58686</a> or <a class="link" href="58942.html">58942</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63857"></a>63857</td>
<td class="instruction">LD B,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63858"></a>63858</td>
<td class="instruction">LD C,62</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63860"></a>63860</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63861"></a>63861</td>
<td class="instruction">LD HL,56893</td>
<td class="comment-11" rowspan="1"><span class="register">HL'</span> will index the sprite tile reference data table at <a class="link" href="56894.html">56894</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63864"></a>63864</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="63865"></a>63865</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63866"></a>63866</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL'</span> at the next sprite tile reference</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63867"></a>63867</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">Collect the tile reference in <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63868"></a>63868</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63869"></a>63869</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Have we reached the end of the table?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63870"></a>63870</td>
<td class="instruction">JR Z,63914</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63872"></a>63872</td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="2">Point <span class="register">DE</span> at the first byte of graphic data for this sprite tile</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63873"></a>63873</td>
<td class="instruction">LD D,199</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63875"></a>63875</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=reference for the replacement tile</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63876"></a>63876</td>
<td class="instruction">INC C</td>
<td class="comment-11" rowspan="1">Point <span class="register">BC</span> at the reference for the next replacement tile</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63877"></a>63877</td>
<td class="instruction">CP 126</td>
<td class="comment-11" rowspan="1">Set the carry flag if the tile reference is &lt; 126</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63879"></a>63879</td>
<td class="instruction">LD L,A</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=reference for the replacement tile</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63880"></a>63880</td>
<td class="instruction">JR NC,63900</td>
<td class="comment-11" rowspan="1">Jump if we're dealing with a tile reference &gt;= 126</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="63882"></a>
<div class="comments">
<div class="paragraph">
We're dealing with a replacement tile (of Sam in disguise) whose reference is &lt; 126. The graphic data for such tiles is arranged in 8 pairs (graphic byte, mask byte) in bytes 80-125 across pages 223-230.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63882"></a>63882</td>
<td class="instruction">LD H,223</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the graphic data for the replacement tile</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="63884"></a>63884</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="2">Copy a byte of graphic data from the replacement tile into the target sprite tile</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63885"></a>63885</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63886"></a>63886</td>
<td class="instruction">INC D</td>
<td class="comment-11" rowspan="1">Point <span class="register">DE</span> at the next byte of mask data for the target sprite tile</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63887"></a>63887</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the next byte of mask data for the replacement tile</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63888"></a>63888</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="2">Copy a byte of mask data from the replacement tile into the target sprite tile</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63889"></a>63889</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63890"></a>63890</td>
<td class="instruction">INC D</td>
<td class="comment-11" rowspan="1">Point <span class="register">DE</span> at the next byte of graphic data for the target sprite tile</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63891"></a>63891</td>
<td class="instruction">DEC L</td>
<td class="comment-11" rowspan="2">Point <span class="register">HL</span> at the next byte of graphic data for the replacement tile</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63892"></a>63892</td>
<td class="instruction">INC H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63893"></a>63893</td>
<td class="instruction">LD A,H</td>
<td class="comment-11" rowspan="2">Have we copied the replacement tile over the target sprite tile yet?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63894"></a>63894</td>
<td class="instruction">CP 231</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63896"></a>63896</td>
<td class="instruction">JR NZ,63884</td>
<td class="comment-11" rowspan="1">Jump back if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63898"></a>63898</td>
<td class="instruction">JR 63865</td>
<td class="comment-11" rowspan="1">Jump back to deal with the next replacement tile</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="63900"></a>
<div class="comments">
<div class="paragraph">
We're dealing with a replacement tile whose reference is &gt;= 126. The graphic data for such tiles is arranged in groups of 16 (8 pairs of graphic bytes and mask bytes) across pages 215-230.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="63900"></a>63900</td>
<td class="instruction">LD H,215</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the graphic data for the replacement tile</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63902"></a>63902</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">Save the replacement tile reference pointer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63903"></a>63903</td>
<td class="instruction">LD B,16</td>
<td class="comment-11" rowspan="1">There are 16 bytes of graphic and mask data to copy</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="63905"></a>63905</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="5">Copy the replacement tile over the target sprite tile</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63906"></a>63906</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63907"></a>63907</td>
<td class="instruction">INC D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63908"></a>63908</td>
<td class="instruction">INC H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63909"></a>63909</td>
<td class="instruction">DJNZ 63905</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63911"></a>63911</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1">Restore the replacement tile reference pointer to <span class="register">BC</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63912"></a>63912</td>
<td class="instruction">JR 63865</td>
<td class="comment-11" rowspan="1">Jump back to deal with the next replacement tile</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="63914"></a>
<div class="comments">
<div class="paragraph">
Now we can draw Sam's disguise in the bottom right of the screen.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="63914"></a>63914</td>
<td class="instruction">LD HL,55170</td>
<td class="comment-11" rowspan="1">This is the address of the tile reference for the top-left tile in Sam's sprite (animatory state <a class="link" href="../graphics/as.html#0">0</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63917"></a>63917</td>
<td class="instruction">LD DE,20669</td>
<td class="comment-11" rowspan="1">20669 is the display file address for the leftmost byte in the top row of pixels of Sam's disguise in the bottom right of the screen</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="63920"></a>63920</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">Save the sprite tile reference pointer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63921"></a>63921</td>
<td class="instruction">LD L,(HL)</td>
<td class="comment-11" rowspan="2">Point <span class="register">HL</span> at the first byte of graphic data for this tile</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63922"></a>63922</td>
<td class="instruction">LD H,199</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="63924"></a>63924</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="7">Copy the tile to the screen</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63925"></a>63925</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63926"></a>63926</td>
<td class="instruction">INC H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63927"></a>63927</td>
<td class="instruction">INC H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63928"></a>63928</td>
<td class="instruction">INC D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63929"></a>63929</td>
<td class="instruction">BIT 3,D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63931"></a>63931</td>
<td class="instruction">JR Z,63924</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63933"></a>63933</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Restore the sprite tile reference pointer to <span class="register">HL</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63934"></a>63934</td>
<td class="instruction">INC H</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the next tile reference</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63935"></a>63935</td>
<td class="instruction">LD D,80</td>
<td class="comment-11" rowspan="4">Set <span class="register">DE</span> to the display file address for the next tile</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63937"></a>63937</td>
<td class="instruction">LD A,E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63938"></a>63938</td>
<td class="instruction">ADD A,32</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63940"></a>63940</td>
<td class="instruction">LD E,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63941"></a>63941</td>
<td class="instruction">JR NC,63920</td>
<td class="comment-11" rowspan="1">Jump back unless we've finished a column of three tiles</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63943"></a>63943</td>
<td class="instruction">CP 31</td>
<td class="comment-11" rowspan="1">Have we just finished the third column?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63945"></a>63945</td>
<td class="instruction">RET Z</td>
<td class="comment-11" rowspan="1">Return if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63946"></a>63946</td>
<td class="instruction">SUB 95</td>
<td class="comment-11" rowspan="2">Set <span class="register">DE</span> to the display file address for the first tile in the next column</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63948"></a>63948</td>
<td class="instruction">LD E,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63949"></a>63949</td>
<td class="instruction">INC H</td>
<td class="comment-11" rowspan="2">Point <span class="register">HL</span> at the reference for the first tile in this column</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63950"></a>63950</td>
<td class="instruction">INC H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63951"></a>63951</td>
<td class="instruction">JR 63920</td>
<td class="comment-11" rowspan="1">Jump back to draw this column of tiles</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="63837.html">63837</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#63838">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="63953.html">63953</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Contact Sam Cruise RAM disassembly 20150417</div>
<div class="copyright">&#169; 1986 Microsphere Computer Services Ltd (Contact Sam Cruise). &#169; 2015 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 4.3.</div>
</div>
</body>
</html>