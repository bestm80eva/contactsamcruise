<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Contact Sam Cruise: Routine at 29733</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../microsphere.css" />
<link rel="stylesheet" type="text/css" href="../csc.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="29731.html">29731</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#29733">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="29851.html">29851</a></span></td>
</tr>
</table>
<div class="description">29733: Show or hide the fuse, door, light bulb or phone in the icon panel (2)</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Continues from the routine at <a class="link" href="29668.html">29668</a>. Checks whether Sam is standing next to a fuse, door, light switch or telephone, and updates the icon panel as appropriate.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">HL</td>
<td class="register-desc">58882 (byte 2 of Sam's buffer)</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="29733"></a>29733</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=Sam's y-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29734"></a>29734</td>
<td class="instruction">LD DE,29647</td>
<td class="comment-11" rowspan="1">Point <span class="register">DE</span> at the list of x-coordinates of the house doors (at <a class="link" href="29647.html">29647</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29737"></a>29737</td>
<td class="instruction">CP 31</td>
<td class="comment-11" rowspan="1">31 is the y-coordinate of the house doors</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29739"></a>29739</td>
<td class="instruction">JR Z,29747</td>
<td class="comment-11" rowspan="1">Jump if Sam's y-coordinate is 31</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29741"></a>29741</td>
<td class="instruction">CP 33</td>
<td class="comment-11" rowspan="1">33 is the y-coordinate of the shop doors</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29743"></a>29743</td>
<td class="instruction">JR NZ,29765</td>
<td class="comment-11" rowspan="1">Jump unless Sam's y-coordinate is 33</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29745"></a>29745</td>
<td class="instruction">LD E,220</td>
<td class="comment-11" rowspan="1"><span class="register">DE</span>=<a class="link" href="29647.html#29660">29660</a> (list of x-coordinates of shop doors)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="29747"></a>29747</td>
<td class="instruction">DEC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=1</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="29748"></a>29748</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=x-coordinate of a door (or 255)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29749"></a>29749</td>
<td class="instruction">INC E</td>
<td class="comment-11" rowspan="1">Point <span class="register">DE</span> at the next x-coordinate in the list</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29750"></a>29750</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="1">Have we reached the end of the list?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29751"></a>29751</td>
<td class="instruction">JR Z,29765</td>
<td class="comment-11" rowspan="1">Jump if so (Sam's not standing next to a door)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29753"></a>29753</td>
<td class="instruction">DEC A</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=x-coordinate of the door</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29754"></a>29754</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="1">Is Sam's x-coordinate the same?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29755"></a>29755</td>
<td class="instruction">JR NZ,29748</td>
<td class="comment-11" rowspan="1">Jump back if not to check the next door</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="29757"></a>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a class="link" href="29668.html">29668</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="29757"></a>29757</td>
<td class="instruction">LD A,(32680)</td>
<td class="comment-11" rowspan="3">Set bit 6 at <a class="link" href="32680.html">32680</a>: door icon</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29760"></a>29760</td>
<td class="instruction">SET 6,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29762"></a>29762</td>
<td class="instruction">LD (32680),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="29765"></a>29765</td>
<td class="instruction">LD L,4</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 4 of Sam's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29767"></a>29767</td>
<td class="instruction">BIT 0,(HL)</td>
<td class="comment-11" rowspan="1">Is Sam indoors?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29769"></a>29769</td>
<td class="instruction">JP Z,<a class="link" href="29668.html#29680">29680</a></td>
<td class="comment-11" rowspan="1">Update the icon panel now if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29772"></a>29772</td>
<td class="instruction">LD L,2</td>
<td class="comment-11" rowspan="2"><span class="register">A</span>=Sam's y-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29774"></a>29774</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29775"></a>29775</td>
<td class="instruction">CP 33</td>
<td class="comment-11" rowspan="1">Is Sam inside a shop?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29777"></a>29777</td>
<td class="instruction">JR Z,29800</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="29779"></a>29779</td>
<td class="instruction">SUB 6</td>
<td class="comment-11" rowspan="2">Keep subtracting 6 (the height of a floor) from Sam's y-coordinate until it's negative</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29781"></a>29781</td>
<td class="instruction">JR NC,29779</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29783"></a>29783</td>
<td class="instruction">CP 251</td>
<td class="comment-11" rowspan="1">Is Sam's y-coordinate 1, 7, 13, 19, 25 or 31?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29785"></a>29785</td>
<td class="instruction">JP NZ,<a class="link" href="29668.html#29680">29680</a></td>
<td class="comment-11" rowspan="1">Update the icon panel now if not (Sam's on a staircase)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29788"></a>29788</td>
<td class="instruction">CALL <a class="link" href="30116.html">30116</a></td>
<td class="comment-11" rowspan="1">Is Sam standing next to a fuse that has not been blown yet?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29791"></a>29791</td>
<td class="instruction">JR NZ,29800</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29793"></a>29793</td>
<td class="instruction">LD HL,32680</td>
<td class="comment-11" rowspan="2">Set bit 7 at <a class="link" href="32680.html">32680</a>: fuse icon</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29796"></a>29796</td>
<td class="instruction">SET 7,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29798"></a>29798</td>
<td class="instruction">LD H,230</td>
<td class="comment-11" rowspan="1">230=Sam</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="29800"></a>29800</td>
<td class="instruction">CALL <a class="link" href="62518.html">62518</a></td>
<td class="comment-11" rowspan="1">Is Sam standing next to a light switch?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29803"></a>29803</td>
<td class="instruction">JR Z,29812</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29805"></a>29805</td>
<td class="instruction">LD HL,32680</td>
<td class="comment-11" rowspan="2">Set bit 5 at <a class="link" href="32680.html">32680</a>: light bulb icon</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29808"></a>29808</td>
<td class="instruction">SET 5,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29810"></a>29810</td>
<td class="instruction">LD H,230</td>
<td class="comment-11" rowspan="1">230=Sam</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="29812"></a>29812</td>
<td class="instruction">CALL <a class="link" href="29854.html">29854</a></td>
<td class="comment-11" rowspan="1">Is Sam standing next to a telephone?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29815"></a>29815</td>
<td class="instruction">JP Z,<a class="link" href="29668.html#29680">29680</a></td>
<td class="comment-11" rowspan="1">Update the icon panel now if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="29818"></a>
<div class="comments">
<div class="paragraph">
Sam is standing next to a telephone. Before showing the telephone icon, we need to update the icon graphic depending on whether the phone is ringing.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29818"></a>29818</td>
<td class="instruction">LD HL,32680</td>
<td class="comment-11" rowspan="2">Set bit 4 at <a class="link" href="32680.html">32680</a>: telephone icon</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29821"></a>29821</td>
<td class="instruction">SET 4,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29823"></a>29823</td>
<td class="instruction">JR C,29841</td>
<td class="comment-11" rowspan="1">Jump if the telephone is not ringing</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29825"></a>29825</td>
<td class="instruction">LD A,(23672)</td>
<td class="comment-11" rowspan="1">Collect the value of the system variable FRAMES, which is incremented every 20ms</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29828"></a>29828</td>
<td class="instruction">BIT 5,A</td>
<td class="comment-11" rowspan="1">Bit 5 of FRAMES alternates every 0.64s</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29830"></a>29830</td>
<td class="instruction">JR Z,29841</td>
<td class="comment-11" rowspan="1">Jump if it's zero now</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29832"></a>29832</td>
<td class="instruction">LD A,(20654)</td>
<td class="comment-11" rowspan="1">20654 is the display file address for the byte in the top-left corner of the telephone icon</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29835"></a>29835</td>
<td class="instruction">DEC A</td>
<td class="comment-11" rowspan="1">Is the telephone icon in the ringing phase at the moment?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29836"></a>29836</td>
<td class="instruction">CALL Z,<a class="link" href="28660.html">28660</a></td>
<td class="comment-11" rowspan="1">If not, make it so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29839"></a>29839</td>
<td class="instruction">JR 29848</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="29841"></a>29841</td>
<td class="instruction">LD A,(20654)</td>
<td class="comment-11" rowspan="1">20654 is the display file address for the byte in the top-left corner of the telephone icon</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29844"></a>29844</td>
<td class="instruction">DEC A</td>
<td class="comment-11" rowspan="1">Is the telephone icon in the ringing phase at the moment?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29845"></a>29845</td>
<td class="instruction">CALL NZ,<a class="link" href="28660.html#28666">28666</a></td>
<td class="comment-11" rowspan="1">If so, make it appear still (as when between rings)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="29848"></a>29848</td>
<td class="instruction">JP <a class="link" href="29668.html#29680">29680</a></td>
<td class="comment-11" rowspan="1">Update the icon panel</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="29731.html">29731</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#29733">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="29851.html">29851</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Contact Sam Cruise RAM disassembly 20140614</div>
<div class="copyright">&#169; 1986 Microsphere Computer Services Ltd (Contact Sam Cruise). &#169; 2014 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://pyskool.ca/?page_id=177">SkoolKit</a> 4.0.</div>
</div>
</body>
</html>