<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Contact Sam Cruise: Routine at 24832</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../csc.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="Contact Sam Cruise" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="24819.html">24819</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#24832">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="24914.html">24914</a></span></td>
</tr>
</table>
<div class="description">24832: Deal with Sam while he's transfixed by Lana</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a class="link" href="29912.html">29912</a> when bit 1 at <a class="link" href="32764.html">32764</a> is set (by the routine at <a class="link" href="29952.html">29952</a>, using the event entry at <a class="link" href="24544.html#24792">24792</a>), indicating that Sam has been immobilised after meeting Lana in his office.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">230 (Sam)</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24832"></a>24832</td>
<td class="instruction">LD L,8</td>
<td class="comment-11" rowspan="2">Set Sam's main action timer (in byte 8 of his buffer) to 8</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24834"></a>24834</td>
<td class="instruction">LD (HL),L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24835"></a>24835</td>
<td class="instruction">LD L,13</td>
<td class="comment-11" rowspan="2">Byte 13 of Sam's buffer holds 0 if Sam has only just met Lana, or 1 otherwise</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24837"></a>24837</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24838"></a>24838</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Has Sam only just met Lana in his office?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24839"></a>24839</td>
<td class="instruction">JR NZ,24850</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24841"></a>24841</td>
<td class="instruction">INC (HL)</td>
<td class="comment-11" rowspan="1">Increment byte 13 of Sam's buffer so that we don't come here again</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24842"></a>24842</td>
<td class="instruction">LD A,73</td>
<td class="comment-11" rowspan="1">Message <a class="link" href="24263.html">73</a>: 'I STARED AT THE LOVELY LANA...'</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24844"></a>24844</td>
<td class="instruction">LD (32722),A</td>
<td class="comment-11" rowspan="1">Store the message number at <a class="link" href="32722.html">32722</a> (so that we can check when it has been displayed)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24847"></a>24847</td>
<td class="instruction">JP <a class="link" href="30154.html">30154</a></td>
<td class="comment-11" rowspan="1">Queue the message urgently</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="24850"></a>
<div class="comments">
<div class="paragraph">
While Lana is transfixing Sam, we count the policemen who have shown up at Sam's office so far and been immobilised.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24850"></a>24850</td>
<td class="instruction">LD BC,512</td>
<td class="comment-11" rowspan="1"><span class="register">B</span>=2 (2 policemen), <span class="register">C</span>=0 (will count the number of immobilised policemen)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24853"></a>24853</td>
<td class="instruction">LD D,222</td>
<td class="comment-11" rowspan="1">Character 222 is the first policeman</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24855"></a>24855</td>
<td class="instruction">LD E,9</td>
<td class="comment-11" rowspan="1">Point <span class="register">DE</span> at byte 9 of the policeman's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24857"></a>24857</td>
<td class="instruction">INC C</td>
<td class="comment-11" rowspan="1">Assume that this policeman is already immobilised</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24858"></a>24858</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=MSB of the policeman's current primary command routine</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24859"></a>24859</td>
<td class="instruction">CP 231</td>
<td class="comment-11" rowspan="1">Is it the MSB of <a class="link" href="59136.html#59147">59147</a> (RET)?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24861"></a>24861</td>
<td class="instruction">JR Z,24890</td>
<td class="comment-11" rowspan="1">Jump if so (this policeman is already immobilised)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24863"></a>24863</td>
<td class="instruction">DEC C</td>
<td class="comment-11" rowspan="1">Decrement <span class="register">C</span> because this policeman is not yet immobilised</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24864"></a>24864</td>
<td class="instruction">LD E,2</td>
<td class="comment-11" rowspan="2"><span class="register">A</span>=policeman's y-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24866"></a>24866</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24867"></a>24867</td>
<td class="instruction">CP 19</td>
<td class="comment-11" rowspan="1">Is the policeman on the third floor of a building?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24869"></a>24869</td>
<td class="instruction">JR NZ,24890</td>
<td class="comment-11" rowspan="1">Jump to consider the next policeman if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24871"></a>24871</td>
<td class="instruction">DEC E</td>
<td class="comment-11" rowspan="1"><span class="register">E</span>=1</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24872"></a>24872</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=policeman's x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24873"></a>24873</td>
<td class="instruction">CP 239</td>
<td class="comment-11" rowspan="4">Consider the next policeman unless this one is in Sam's office</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24875"></a>24875</td>
<td class="instruction">JR NC,24890</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24877"></a>24877</td>
<td class="instruction">CP 224</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24879"></a>24879</td>
<td class="instruction">JR C,24890</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24881"></a>24881</td>
<td class="instruction">LD A,231</td>
<td class="comment-11" rowspan="6">Place <a class="link" href="59136.html#59147">59147</a> (RET) into bytes 8 and 9 of the policeman's buffer, thus immobilising him</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24883"></a>24883</td>
<td class="instruction">LD E,9</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24885"></a>24885</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24886"></a>24886</td>
<td class="instruction">LD A,11</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24888"></a>24888</td>
<td class="instruction">DEC E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24889"></a>24889</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24890"></a>24890</td>
<td class="instruction">INC D</td>
<td class="comment-11" rowspan="1">Point <span class="register">DE</span> at the next policeman's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24891"></a>24891</td>
<td class="instruction">DJNZ 24855</td>
<td class="comment-11" rowspan="1">Jump back until both policemen have been checked</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="24893"></a>
<div class="comments">
<div class="paragraph">
Now <span class="register">C</span> holds the number of policemen that have been immobilised in Sam's office.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24893"></a>24893</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">Save the number of immobilised policemen briefly</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24894"></a>24894</td>
<td class="instruction">CALL <a class="link" href="30972.html">30972</a></td>
<td class="comment-11" rowspan="1">Check whether message <a class="link" href="24263.html">73</a> ('I STARED AT THE LOVELY LANA...') is still in the message queue</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24897"></a>24897</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1">Restore the number of immobilised policemen to <span class="register">C</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24898"></a>24898</td>
<td class="instruction">RET Z</td>
<td class="comment-11" rowspan="1">Return unless the entire message has been displayed</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24899"></a>24899</td>
<td class="instruction">LD A,C</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=number of immobilised policemen</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24900"></a>24900</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Is it at least one?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24901"></a>24901</td>
<td class="instruction">JR NZ,<a class="link" href="24914.html">24914</a></td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24903"></a>24903</td>
<td class="instruction">LD HL,0</td>
<td class="comment-11" rowspan="2">Set the number of bucks (stored at <a class="link" href="32670.html">32670</a>) to 0</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24906"></a>24906</td>
<td class="instruction">LD (32670),HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24909"></a>24909</td>
<td class="instruction">LD A,75</td>
<td class="comment-11" rowspan="1">Message <a class="link" href="24514.html">75</a>: 'SHE FIRED'</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24911"></a>24911</td>
<td class="instruction">JP <a class="link" href="31414.html#31445">31445</a></td>
<td class="comment-11" rowspan="1">Display the cutscene with this message, and then prepare to enter demo mode</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="24819.html">24819</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#24832">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="24914.html">24914</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Contact Sam Cruise RAM disassembly 20150417</div>
<div class="copyright">&#169; 1986 Microsphere Computer Services Ltd (Contact Sam Cruise). &#169; 2015 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 4.3.</div>
</div>
</body>
</html>