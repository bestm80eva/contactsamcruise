<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Contact Sam Cruise: Routine at 59861</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../csc.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="Contact Sam Cruise" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="59848.html">59848</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#59861">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="60032.html">60032</a></span></td>
</tr>
</table>
<div class="description">59861: Update a character's animatory state and location and update the SRB</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routines at <a class="link" href="25420.html">25420</a>, <a class="link" href="25789.html">25789</a>, <a class="link" href="26224.html">26224</a>, <a class="link" href="29149.html">29149</a>, <a class="link" href="30989.html">30989</a>, <a class="link" href="31204.html">31204</a>, <a class="link" href="31476.html">31476</a>, <a class="link" href="31670.html">31670</a>, <a class="link" href="31713.html">31713</a>, <a class="link" href="60347.html">60347</a>, <a class="link" href="60506.html">60506</a>, <a class="link" href="62264.html">62264</a>, <a class="link" href="62325.html">62325</a>, <a class="link" href="63281.html">63281</a>, <a class="link" href="63558.html">63558</a>, <a class="link" href="63954.html">63954</a>, <a class="link" href="64131.html">64131</a> and <a class="link" href="64227.html">64227</a>. Sets the new animatory state and location of a character, and updates the <a class="link" href="32512.html">screen refresh buffer</a> (SRB) accordingly.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">A</td>
<td class="register-desc">New animatory state</td>
</tr>
<tr>
<td class="register">D</td>
<td class="register-desc">New y-coordinate</td>
</tr>
<tr>
<td class="register">E</td>
<td class="register-desc">New x-coordinate</td>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Character number (215-230)</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59861"></a>59861</td>
<td class="instruction">LD L,2</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 2 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59863"></a>59863</td>
<td class="instruction">LD (HL),D</td>
<td class="comment-11" rowspan="1">Fill in the new y-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59864"></a>59864</td>
<td class="instruction">DEC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=1</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59865"></a>59865</td>
<td class="instruction">LD (HL),E</td>
<td class="comment-11" rowspan="1">Fill in the new x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59866"></a>59866</td>
<td class="instruction">DEC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=0</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59867"></a>59867</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-11" rowspan="1">Fill in the new animatory state</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="59868"></a>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a class="link" href="59848.html">59848</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59868"></a>59868</td>
<td class="instruction">LD BC,514</td>
<td class="comment-11" rowspan="1"><span class="register">B</span>=2, <span class="register">C</span>=2</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59871"></a>59871</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character's animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59872"></a>59872</td>
<td class="instruction">AND 127</td>
<td class="comment-11" rowspan="1">Clear the 'direction' bit (bit 7)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59874"></a>59874</td>
<td class="instruction">ADD A,136</td>
<td class="comment-11" rowspan="1">Is the animatory state &gt;= <a class="link" href="../graphics/as.html#120">120</a>?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59876"></a>59876</td>
<td class="instruction">JR C,59889</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59878"></a>59878</td>
<td class="instruction">LD BC,1283</td>
<td class="comment-11" rowspan="1"><span class="register">B</span>=5, <span class="register">C</span>=3</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59881"></a>59881</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="2">Is the animatory state equal to 7 mod 8?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59882"></a>59882</td>
<td class="instruction">AND 7</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59884"></a>59884</td>
<td class="instruction">JR NZ,59889</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59886"></a>59886</td>
<td class="instruction">LD BC,773</td>
<td class="comment-11" rowspan="1"><span class="register">B</span>=3, <span class="register">C</span>=5</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="59889"></a>
<div class="comments">
<div class="paragraph">
Now <span class="register">B</span> holds the height of the sprite in tiles, and <span class="register">C</span> holds the width.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59889"></a>59889</td>
<td class="instruction">LD A,(32767)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=Y, the y-coordinate of the topmost row of the play area on screen (2-20)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59892"></a>59892</td>
<td class="instruction">SUB B</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=Y-<span class="register">B</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59893"></a>59893</td>
<td class="instruction">JR C,59897</td>
<td class="comment-11" rowspan="1">Jump if <span class="register">B</span>&gt;Y</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59895"></a>59895</td>
<td class="instruction">CP D</td>
<td class="comment-11" rowspan="1">Is the character entirely above the portion of the play area currently on screen?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59896"></a>59896</td>
<td class="instruction">RET NC</td>
<td class="comment-11" rowspan="1">Return if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59897"></a>59897</td>
<td class="instruction">ADD A,B</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=Y</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59898"></a>59898</td>
<td class="instruction">ADD A,19</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=y-coordinate of the bottom row of the play area on screen (21-39)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59900"></a>59900</td>
<td class="instruction">SUB D</td>
<td class="comment-11" rowspan="1">Is the character entirely below the portion of the play area currently on screen?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59901"></a>59901</td>
<td class="instruction">RET C</td>
<td class="comment-11" rowspan="1">Return if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59902"></a>59902</td>
<td class="instruction">CPL</td>
<td class="comment-11" rowspan="4"><span class="register">A</span>=4*(<span class="register">D</span>-Y+4)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59903"></a>59903</td>
<td class="instruction">ADD A,24</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59905"></a>59905</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59906"></a>59906</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59907"></a>59907</td>
<td class="instruction">LD D,A</td>
<td class="comment-11" rowspan="1">Copy this value (0, 4, 8, 12,...92) to <span class="register">D</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59908"></a>59908</td>
<td class="instruction">LD A,(32766)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=X, the x-coordinate of the leftmost column of the play area on screen</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59911"></a>59911</td>
<td class="instruction">SUB C</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=X-<span class="register">C</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59912"></a>59912</td>
<td class="instruction">JR C,59916</td>
<td class="comment-11" rowspan="1">Jump if <span class="register">C</span>&gt;X</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59914"></a>59914</td>
<td class="instruction">CP E</td>
<td class="comment-11" rowspan="1">Is the character entirely off-screen to the left?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59915"></a>59915</td>
<td class="instruction">RET NC</td>
<td class="comment-11" rowspan="1">Return if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59916"></a>59916</td>
<td class="instruction">ADD A,C</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=X</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59917"></a>59917</td>
<td class="instruction">ADD A,31</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=x-coordinate of the rightmost column of the play area on screen</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59919"></a>59919</td>
<td class="instruction">SUB E</td>
<td class="comment-11" rowspan="1">Is the character entirely off-screen to the right?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59920"></a>59920</td>
<td class="instruction">RET C</td>
<td class="comment-11" rowspan="1">Return if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="59921"></a>
<div class="comments">
<div class="paragraph">
If we get here, then the character's sprite (or at least a portion of it) is on-screen.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59921"></a>59921</td>
<td class="instruction">CPL</td>
<td class="comment-11" rowspan="2"><span class="register">A</span>=<span class="register">E</span>-X: the character's screen x-coordinate (-4 to 31)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59922"></a>59922</td>
<td class="instruction">ADD A,32</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59924"></a>59924</td>
<td class="instruction">PUSH AF</td>
<td class="comment-11" rowspan="1">Save this temporarily</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59925"></a>59925</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character's animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59926"></a>59926</td>
<td class="instruction">AND 7</td>
<td class="comment-11" rowspan="1">Set the zero flag if the animatory state is 0 mod 8</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59928"></a>59928</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character's animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59929"></a>59929</td>
<td class="instruction">JR NZ,59933</td>
<td class="comment-11" rowspan="1">Jump unless the animatory state is 0 mod 8</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59931"></a>59931</td>
<td class="instruction">ADD A,2</td>
<td class="comment-11" rowspan="1">Add 2 if the animatory state is congruent to 0 mod 8</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59933"></a>59933</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">Push the sprite dimensions onto the stack</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59934"></a>59934</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59935"></a>59935</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1">Retrieve the sprite dimensions in <span class="register">BC'</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59936"></a>59936</td>
<td class="instruction">LD H,215</td>
<td class="comment-11" rowspan="1">Page 215 holds sprite tile references for the top-left tile (tile 0) in the left-facing sprites</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59938"></a>59938</td>
<td class="instruction">LD D,B</td>
<td class="comment-11" rowspan="1"><span class="register">D'</span>=sprite height (2, 3 or 5)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59939"></a>59939</td>
<td class="instruction">RLCA</td>
<td class="comment-11" rowspan="3">Set bit 7 of <span class="register">A</span>, and set the carry flag if the character is facing right</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59940"></a>59940</td>
<td class="instruction">SCF</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59941"></a>59941</td>
<td class="instruction">RRA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59942"></a>59942</td>
<td class="instruction">LD L,A</td>
<td class="comment-11" rowspan="1"><span class="register">L'</span>=character's animatory state (with bit 7 set)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59943"></a>59943</td>
<td class="instruction">JR NC,59956</td>
<td class="comment-11" rowspan="1">Jump if the character is facing left</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59945"></a>59945</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="3"><span class="register">D'</span>=-<span class="register">B'</span> (negative sprite height)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59946"></a>59946</td>
<td class="instruction">SUB B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59947"></a>59947</td>
<td class="instruction">LD D,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59948"></a>59948</td>
<td class="instruction">LD E,C</td>
<td class="comment-11" rowspan="2"><span class="register">E'</span>=<span class="register">C'</span>-1 (sprite width minus 1)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59949"></a>59949</td>
<td class="instruction">DEC E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59950"></a>59950</td>
<td class="instruction">LD A,H</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=215 (page containing references for sprite tile 0)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59951"></a>59951</td>
<td class="instruction">ADD A,B</td>
<td class="comment-11" rowspan="3"><span class="register">A</span>=215+<span class="register">B'</span>*(<span class="register">C'</span>-1)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59952"></a>59952</td>
<td class="instruction">DEC E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59953"></a>59953</td>
<td class="instruction">JR NZ,59951</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59955"></a>59955</td>
<td class="instruction">LD H,A</td>
<td class="comment-11" rowspan="1">Copy this value to <span class="register">H'</span></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="59956"></a>
<div class="comments">
<div class="paragraph">
Now <span class="register">HL'</span> points at the sprite tile reference for the top-left tile in the character's sprite.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59956"></a>59956</td>
<td class="instruction">POP AF</td>
<td class="comment-11" rowspan="1">Restore the character's screen x-coordinate to <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59957"></a>59957</td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1">Copy it to <span class="register">E'</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59958"></a>59958</td>
<td class="instruction">JR C,59967</td>
<td class="comment-11" rowspan="1">Jump if <span class="register">E'</span>&gt;=0 (meaning that the leftmost tiles in the character's sprite are on-screen)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59960"></a>59960</td>
<td class="instruction">LD A,H</td>
<td class="comment-11" rowspan="5"><span class="register">A</span>=<span class="register">H'</span>-<span class="register">D'</span>*<span class="register">E'</span> (sprite tile reference page number); <span class="register">C'</span>=<span class="register">C'</span>+<span class="register">E'</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59961"></a>59961</td>
<td class="instruction">ADD A,D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59962"></a>59962</td>
<td class="instruction">DEC C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59963"></a>59963</td>
<td class="instruction">INC E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59964"></a>59964</td>
<td class="instruction">JR NZ,59961</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59966"></a>59966</td>
<td class="instruction">LD H,A</td>
<td class="comment-11" rowspan="1">Copy the sprite tile reference page number to <span class="register">H'</span></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="59967"></a>
<div class="comments">
<div class="paragraph">
Now <span class="register">HL'</span> points at the sprite tile reference for the tile in the top row and the leftmost column of the character's sprite that is on-screen. <span class="register">C'</span> holds the number of tile columns of the character's sprite that are to the right of the left edge of the screen.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59967"></a>59967</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=leftmost column of the screen occupied by the sprite (0-31)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59968"></a>59968</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59969"></a>59969</td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1"><span class="register">E</span>=leftmost column of the screen occupied by the sprite</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59970"></a>59970</td>
<td class="instruction">AND 7</td>
<td class="comment-11" rowspan="4">Point <span class="register">BC</span> at byte 21 of page 160+(<span class="register">E</span>%8)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59972"></a>59972</td>
<td class="instruction">ADD A,160</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59974"></a>59974</td>
<td class="instruction">LD B,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59975"></a>59975</td>
<td class="instruction">LD C,21</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59977"></a>59977</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-11" rowspan="1">Pick up the contents in <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59978"></a>59978</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1">Copy them to <span class="register">C</span></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="59979"></a>
<div class="comments">
<div class="paragraph">
Now <span class="register">C</span> holds 1, 2, 4, 8, 16, 32, 64 or 128. The bit set in <span class="register">C</span> corresponds to the bit that needs to be set in the relevant byte of the screen refresh buffer (SRB).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59979"></a>59979</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=leftmost column of the screen occupied by the sprite (0-31)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59980"></a>59980</td>
<td class="instruction">RRCA</td>
<td class="comment-11" rowspan="5">Set <span class="register">A</span> to the LSB of the first byte of the SRB that needs to be modified: <span class="register">D</span>+INT(<span class="register">E</span>/8)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59981"></a>59981</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59982"></a>59982</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59983"></a>59983</td>
<td class="instruction">AND 3</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59985"></a>59985</td>
<td class="instruction">ADD A,D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59986"></a>59986</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1">Copy this LSB to <span class="register">B</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59987"></a>59987</td>
<td class="instruction">LD D,127</td>
<td class="comment-11" rowspan="1">The SRB is in page 127</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59989"></a>59989</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="59990"></a>
<div class="comments">
<div class="paragraph">
Here we enter a loop to set the appropriate bits in the SRB. At this point <span class="register">B'</span> holds the number of tile rows in the sprite (2, 3, or 5) and <span class="register">C'</span> holds the number of tile columns of the sprite that are to the right of the left edge of the screen.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59990"></a>59990</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">Save the tile row and column counters temporarily</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59991"></a>59991</td>
<td class="instruction">LD E,0</td>
<td class="comment-11" rowspan="1">Start at sprite tile row 0 (top row)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59993"></a>59993</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">Pick up the sprite tile reference in <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59994"></a>59994</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Is this the 'null' tile (blank square)?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59995"></a>59995</td>
<td class="instruction">JR Z,60007</td>
<td class="comment-11" rowspan="1">Jump if so (no need to set a bit in the SRB)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59997"></a>59997</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=sprite tile row number (0-4)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59998"></a>59998</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59999"></a>59999</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="2">Multiply by 4 (the number of bytes of the SRB that correspond to one row of the screen)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60000"></a>60000</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60001"></a>60001</td>
<td class="instruction">ADD A,B</td>
<td class="comment-11" rowspan="2">Point <span class="register">DE</span> at the relevant byte of the SRB</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60002"></a>60002</td>
<td class="instruction">LD E,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60003"></a>60003</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">Pick up the SRB byte in <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60004"></a>60004</td>
<td class="instruction">OR C</td>
<td class="comment-11" rowspan="1">Make sure the appropriate bit is set</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60005"></a>60005</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-11" rowspan="1">Restore the SRB byte with the appropriate bit set</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60006"></a>60006</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="60007"></a>60007</td>
<td class="instruction">INC H</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL'</span> at the reference for the next tile in the sprite (one row down)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60008"></a>60008</td>
<td class="instruction">INC E</td>
<td class="comment-11" rowspan="1">Next row down in this column of the sprite</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60009"></a>60009</td>
<td class="instruction">DJNZ 59993</td>
<td class="comment-11" rowspan="1">Jump back until we've set all the SRB bits for this tile column of the sprite</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60011"></a>60011</td>
<td class="instruction">LD A,H</td>
<td class="comment-11" rowspan="5">Point <span class="register">HL'</span> at the reference for the tile in the top row of the next column of the sprite</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60012"></a>60012</td>
<td class="instruction">ADD A,D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60013"></a>60013</td>
<td class="instruction">POP BC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60014"></a>60014</td>
<td class="instruction">SUB B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60015"></a>60015</td>
<td class="instruction">LD H,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60016"></a>60016</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60017"></a>60017</td>
<td class="instruction">RRC C</td>
<td class="comment-11" rowspan="1">Move the SRB marker bit in <span class="register">C</span> one place to the right (possibly wrapping round to bit 7)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60019"></a>60019</td>
<td class="instruction">JR NC,60026</td>
<td class="comment-11" rowspan="1">Jump if there are still bits to be set in the current SRB byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60021"></a>60021</td>
<td class="instruction">INC B</td>
<td class="comment-11" rowspan="1">Otherwise move along to the next byte in the SRB</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60022"></a>60022</td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=LSB of the next SRB byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60023"></a>60023</td>
<td class="instruction">AND 3</td>
<td class="comment-11" rowspan="1">Does the next SRB byte correspond to a segment in the leftmost 8 columns of the screen (i.e. have we wrapped around from right to left)?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60025"></a>60025</td>
<td class="instruction">RET Z</td>
<td class="comment-11" rowspan="1">Return if so (any remaining sprite tile columns are off-screen to the right)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="60026"></a>60026</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60027"></a>60027</td>
<td class="instruction">DEC C</td>
<td class="comment-11" rowspan="1">Next sprite tile column</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60028"></a>60028</td>
<td class="instruction">JR NZ,59990</td>
<td class="comment-11" rowspan="1">Jump back until the relevant SRB bits for every sprite tile column have been set</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60030"></a>60030</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60031"></a>60031</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="59848.html">59848</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#59861">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="60032.html">60032</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Contact Sam Cruise RAM disassembly 20150417</div>
<div class="copyright">&#169; 1986 Microsphere Computer Services Ltd (Contact Sam Cruise). &#169; 2015 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 4.3.</div>
</div>
</body>
</html>