<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Contact Sam Cruise: Routine at 31126</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../csc.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="Contact Sam Cruise" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="31110.html">31110</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#31126">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="31204.html">31204</a></span></td>
</tr>
</table>
<div class="description">31126: Collect a keypress during the game (or simulate one in demo mode)</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Called from the main loop at <a class="link" href="61483.html">61483</a>.
</div>
</div>
<table class="input-0">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>

</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="31126"></a>31126</td>
<td class="instruction">LD A,(32750)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=current game mode (0-4)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31129"></a>31129</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Is it demo mode?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31130"></a>31130</td>
<td class="instruction">JP NZ,<a class="link" href="60082.html">60082</a></td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="31133"></a>
<div class="comments">
<div class="paragraph">
It's demo mode.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31133"></a>31133</td>
<td class="instruction">CALL <a class="link" href="60121.html">60121</a></td>
<td class="comment-11" rowspan="1">Collect the ASCII code of the last key pressed in <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31136"></a>31136</td>
<td class="instruction">JP NZ,<a class="link" href="61630.html#61674">61674</a></td>
<td class="comment-11" rowspan="1">Start a new game if a game key was pressed</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31139"></a>31139</td>
<td class="instruction">LD A,38</td>
<td class="comment-11" rowspan="1">Message <a class="link" href="27089.html">38</a>: 'PRESS A KEY TO PLAY'</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31141"></a>31141</td>
<td class="instruction">LD (32722),A</td>
<td class="comment-11" rowspan="1">Store this message number at <a class="link" href="32722.html">32722</a> so that it can be monitored</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31144"></a>31144</td>
<td class="instruction">CALL <a class="link" href="30972.html#30975">30975</a></td>
<td class="comment-11" rowspan="1">Is this message in the message queue?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31147"></a>31147</td>
<td class="instruction">CALL NZ,<a class="link" href="28357.html">28357</a></td>
<td class="comment-11" rowspan="1">If not, add it to the message queue (again)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31150"></a>31150</td>
<td class="instruction">LD A,248</td>
<td class="comment-11" rowspan="2">Set bits 3-7 at <a class="link" href="32746.html">32746</a>, effectively giving Sam the keys to all the houses</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31152"></a>31152</td>
<td class="instruction">LD (32746),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31155"></a>31155</td>
<td class="instruction">LD A,(58891)</td>
<td class="comment-11" rowspan="1">Pick up byte 11 of Sam's buffer (which holds his destination y-coordinate)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31158"></a>31158</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Has a destination been set for Sam yet?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31159"></a>31159</td>
<td class="instruction">JR NZ,31188</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="31161"></a>
<div class="comments">
<div class="paragraph">
We need to set a new destination for Sam.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="31161"></a>31161</td>
<td class="instruction">CALL <a class="link" href="61823.html">61823</a></td>
<td class="comment-11" rowspan="3">Get an even random number between 134 and 148 in <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31164"></a>31164</td>
<td class="instruction">AND 14</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31166"></a>31166</td>
<td class="instruction">ADD A,134</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31168"></a>31168</td>
<td class="instruction">LD L,A</td>
<td class="comment-11" rowspan="2">Point <span class="register">HL</span> at an entry in the table of locations at <a class="link" href="31110.html">31110</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31169"></a>31169</td>
<td class="instruction">LD H,121</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31171"></a>31171</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-11" rowspan="3">Collect the location coordinates in <span class="register">DE</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31172"></a>31172</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31173"></a>31173</td>
<td class="instruction">LD D,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31174"></a>31174</td>
<td class="instruction">LD HL,58890</td>
<td class="comment-11" rowspan="4">Copy the location coordinates into bytes 10 and 11 of Sam's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31177"></a>31177</td>
<td class="instruction">LD (HL),E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31178"></a>31178</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31179"></a>31179</td>
<td class="instruction">LD (HL),D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31180"></a>31180</td>
<td class="instruction">LD C,1</td>
<td class="comment-11" rowspan="1">Assume a z-coordinate of 1 (indoors)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31182"></a>31182</td>
<td class="instruction">CALL <a class="link" href="60726.html#60743">60743</a></td>
<td class="comment-11" rowspan="1">Obtain an identifier for the location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31185"></a>31185</td>
<td class="instruction">LD L,12</td>
<td class="comment-11" rowspan="2">Copy the destination location identifier into byte 12 of Sam's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31187"></a>31187</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="31188"></a>31188</td>
<td class="instruction">LD H,230</td>
<td class="comment-11" rowspan="1">230=Sam</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31190"></a>31190</td>
<td class="instruction">CALL <a class="link" href="60812.html">60812</a></td>
<td class="comment-11" rowspan="1">Determine the next move Sam should make to reach his destination</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31193"></a>31193</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Is Sam already at his destination?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31194"></a>31194</td>
<td class="instruction">JR Z,31161</td>
<td class="comment-11" rowspan="1">Jump back to set a new destination if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="31196"></a>
<div class="comments">
<div class="paragraph">
Sam's destination has been set. Now to simulate a keypress that will make him take the next step towards it.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31196"></a>31196</td>
<td class="instruction">ADD A,127</td>
<td class="comment-11" rowspan="3">Point <span class="register">HL</span> at the offset of the appropriate keypress to simulate in the table at <a class="link" href="31104.html">31104</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31198"></a>31198</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31199"></a>31199</td>
<td class="instruction">LD H,121</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31201"></a>31201</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">Pick up the keypress offset</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31202"></a>31202</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Make sure the zero flag is reset to indicate that a simulated keypress was made (this instruction is redundant)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31203"></a>31203</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="31110.html">31110</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#31126">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="31204.html">31204</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Contact Sam Cruise RAM disassembly 20150417</div>
<div class="copyright">&#169; 1986 Microsphere Computer Services Ltd (Contact Sam Cruise). &#169; 2015 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 4.3.</div>
</div>
</body>
</html>