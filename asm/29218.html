<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Contact Sam Cruise: Routine at 29218</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../csc.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="Contact Sam Cruise" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="29194.html">29194</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#29218">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="29332.html">29332</a></span></td>
</tr>
</table>
<div class="description">29218: Make a policeman start chasing Sam if appropriate</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a class="link" href="29559.html">29559</a>. Returns with the carry flag reset if the policeman spots, recognises and starts chasing Sam.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">222 or 223 (policeman)</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="29218"></a>29218</td>
<td class="instruction">CALL <a class="link" href="28842.html">28842</a></td>
<td class="comment-11" rowspan="1">Is Sam close enough that the policeman has a chance of spotting him?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29221"></a>29221</td>
<td class="instruction">CCF</td>
<td class="comment-11" rowspan="2">Return with the carry flag set if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29222"></a>29222</td>
<td class="instruction">RET C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29223"></a>29223</td>
<td class="instruction">PUSH DE</td>
<td class="comment-11" rowspan="1"><span class="register">E</span> and <span class="register">D</span> hold the horizontal and vertical distances between Sam and the policeman; save these briefly</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29224"></a>29224</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">Save the policeman's character number briefly</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29225"></a>29225</td>
<td class="instruction">LD H,230</td>
<td class="comment-11" rowspan="1">230=Sam</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29227"></a>29227</td>
<td class="instruction">CALL <a class="link" href="28886.html">28886</a></td>
<td class="comment-11" rowspan="1">Check whether Sam is visible to passers-by</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29230"></a>29230</td>
<td class="instruction">LD B,6</td>
<td class="comment-11" rowspan="1">Prepare <span class="register">B</span> for the case where Sam is visible to passers-by</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29232"></a>29232</td>
<td class="instruction">JR Z,29248</td>
<td class="comment-11" rowspan="1">Jump if Sam is visible to passers-by</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29234"></a>29234</td>
<td class="instruction">CALL <a class="link" href="62518.html">62518</a></td>
<td class="comment-11" rowspan="1">Is Sam standing next to a light switch?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29237"></a>29237</td>
<td class="instruction">JR Z,29247</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29239"></a>29239</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=window flags for Sam's location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29240"></a>29240</td>
<td class="instruction">AND 32</td>
<td class="comment-11" rowspan="1">Set the zero flag if the light switch for this window is in the 'on' position</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29242"></a>29242</td>
<td class="instruction">LD A,4</td>
<td class="comment-11" rowspan="1">Prepare <span class="register">A</span> for the case where Sam is standing next to a light switch in the 'on' position</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29244"></a>29244</td>
<td class="instruction">JR Z,29247</td>
<td class="comment-11" rowspan="1">Jump if the light switch for this window is in the 'on' position</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29246"></a>29246</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="1">Prepare <span class="register">A</span> for the case where Sam is neither visible to passers-by nor standing next to a light switch in the 'on' position</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="29247"></a>29247</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1"><span class="register">B</span>=0, 4 or 6</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="29248"></a>
<div class="comments">
<div class="paragraph">
Now <span class="register">B</span>=6 (if Sam is visible to passers-by), or 4 (if Sam is standing next to a light switch that is in the 'on' position), or 0 otherwise.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="29248"></a>29248</td>
<td class="instruction">CALL <a class="link" href="29332.html">29332</a></td>
<td class="comment-11" rowspan="1">Check whether Sam's disguise is known to the police</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29251"></a>29251</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Restore the policeman's character number to <span class="register">H</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29252"></a>29252</td>
<td class="instruction">POP DE</td>
<td class="comment-11" rowspan="1">Restore the horizontal and vertical distances between Sam and the policeman to <span class="register">E</span> and <span class="register">D</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29253"></a>29253</td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=0, 1, 4, 5, 6 or 7</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29254"></a>29254</td>
<td class="instruction">CP 6</td>
<td class="comment-11" rowspan="1">Is Sam visible to passers-by?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29256"></a>29256</td>
<td class="instruction">JR NC,29265</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29258"></a>29258</td>
<td class="instruction">CALL <a class="link" href="28886.html">28886</a></td>
<td class="comment-11" rowspan="1">Is the policeman visible to passers-by?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29261"></a>29261</td>
<td class="instruction">JR NZ,29265</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29263"></a>29263</td>
<td class="instruction">INC B</td>
<td class="comment-11" rowspan="2"><span class="register">B</span>=2, 3, 6 or 7</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29264"></a>29264</td>
<td class="instruction">INC B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="29265"></a>29265</td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=0-7</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29266"></a>29266</td>
<td class="instruction">LD L,A</td>
<td class="comment-11" rowspan="1">Save this value in <span class="register">L</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29267"></a>29267</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="5">Point <span class="register">BC</span> at an entry in the table at <a class="link" href="29194.html">29194</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29268"></a>29268</td>
<td class="instruction">ADD A,B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29269"></a>29269</td>
<td class="instruction">ADD A,10</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29271"></a>29271</td>
<td class="instruction">LD C,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29272"></a>29272</td>
<td class="instruction">LD B,114</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29274"></a>29274</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-11" rowspan="1">Pick up the first byte of the entry</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29275"></a>29275</td>
<td class="instruction">CP D</td>
<td class="comment-11" rowspan="1">Compare it with the vertical distance between Sam and the policeman</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29276"></a>29276</td>
<td class="instruction">RET C</td>
<td class="comment-11" rowspan="1">Return (with the carry flag set) if the vertical distance is greater</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29277"></a>29277</td>
<td class="instruction">INC C</td>
<td class="comment-11" rowspan="2">Pick up the second byte of the entry</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29278"></a>29278</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29279"></a>29279</td>
<td class="instruction">CP E</td>
<td class="comment-11" rowspan="1">Compare it with the horizontal distance between Sam and the policeman</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29280"></a>29280</td>
<td class="instruction">RET C</td>
<td class="comment-11" rowspan="1">Return (with the carry flag set) if the horizontal distance is greater</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29281"></a>29281</td>
<td class="instruction">INC C</td>
<td class="comment-11" rowspan="2">Pick up the third byte of the entry</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29282"></a>29282</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29283"></a>29283</td>
<td class="instruction">SUB D</td>
<td class="comment-11" rowspan="2">Subtract both the horizontal and vertical distances between Sam and the policeman</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29284"></a>29284</td>
<td class="instruction">SUB E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29285"></a>29285</td>
<td class="instruction">RET C</td>
<td class="comment-11" rowspan="1">Return (with the carry flag set) if the result is negative</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29286"></a>29286</td>
<td class="instruction">BIT 0,L</td>
<td class="comment-11" rowspan="1">Bit 0 of <span class="register">L</span> is set if Sam's current disguise (if any) is known to the police</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29288"></a>29288</td>
<td class="instruction">LD L,29</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 29 of the policeman's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29290"></a>29290</td>
<td class="instruction">JR NZ,29322</td>
<td class="comment-11" rowspan="1">Jump if Sam's current disguise is known to the police</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="29292"></a>
<div class="comments">
<div class="paragraph">
Sam has been spotted by the policeman, but he's wearing a disguise that is not (yet) known to the police.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29292"></a>29292</td>
<td class="instruction">LD A,(32713)</td>
<td class="comment-11" rowspan="1">Collect Sam's current disguise ID (1-7) from <a class="link" href="32713.html">32713</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29295"></a>29295</td>
<td class="instruction">RRCA</td>
<td class="comment-11" rowspan="3">Move bits 0-2 into bits 5-7</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29296"></a>29296</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29297"></a>29297</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29298"></a>29298</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1">Copy these disguise identifier bits into <span class="register">C</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29299"></a>29299</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">Pick up byte 29 of the policeman's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29300"></a>29300</td>
<td class="instruction">AND 31</td>
<td class="comment-11" rowspan="1">Keep only bits 0-4 (the disguise timeout counter)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29302"></a>29302</td>
<td class="instruction">JR NZ,29306</td>
<td class="comment-11" rowspan="1">Jump unless they are all 0</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29304"></a>29304</td>
<td class="instruction">LD A,16</td>
<td class="comment-11" rowspan="1">The disguise timeout counter will be initialised to 16</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="29306"></a>29306</td>
<td class="instruction">OR C</td>
<td class="comment-11" rowspan="1">Copy the disguise identifier bits from <span class="register">C</span> into bits 5-7 of <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29307"></a>29307</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-11" rowspan="1">Copy the disguise identifier bits and the timeout counter into byte 29 of the policeman's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29308"></a>29308</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=30</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29309"></a>29309</td>
<td class="instruction">CALL <a class="link" href="25944.html">25944</a></td>
<td class="comment-11" rowspan="1">Determine Sam's location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29312"></a>29312</td>
<td class="instruction">LD (HL),E</td>
<td class="comment-11" rowspan="1">Copy Sam's x-coordinate into byte 30 of the policeman's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29313"></a>29313</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=31</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29314"></a>29314</td>
<td class="instruction">AND 3</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=0 if z (Sam's z-coordinate) is 4, 2 if z is 2, or 1 if z is 1</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29316"></a>29316</td>
<td class="instruction">RRCA</td>
<td class="comment-11" rowspan="2"><span class="register">A</span>=0 if z=4, 128 (bit 7 set) if z=2, or 64 (bit 6 set) if z=1</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29317"></a>29317</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29318"></a>29318</td>
<td class="instruction">OR D</td>
<td class="comment-11" rowspan="1">Copy Sam's y-coordinate into bits 0-5 of <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29319"></a>29319</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-11" rowspan="1">Copy this value into byte 31 of the policeman's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29320"></a>29320</td>
<td class="instruction">SCF</td>
<td class="comment-11" rowspan="1">Set the carry flag: the policeman is not chasing Sam</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29321"></a>29321</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="29322"></a>
<div class="comments">
<div class="paragraph">
Sam has been spotted by the policeman, and his current disguise (if any) is known to the police.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="29322"></a>29322</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">Collect byte 29 of the policeman's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29323"></a>29323</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Is there a disguise ID in bits 5-7?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29324"></a>29324</td>
<td class="instruction">CALL NZ,<a class="link" href="29100.html#29126">29126</a></td>
<td class="comment-11" rowspan="1">If so, make that disguise known to the police (if it isn't already)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29327"></a>29327</td>
<td class="instruction">CALL <a class="link" href="29088.html">29088</a></td>
<td class="comment-11" rowspan="1">Set the policeman's destination to Sam's current location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29330"></a>29330</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Clear the carry flag to indicate that the policeman is now chasing Sam</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29331"></a>29331</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="29194.html">29194</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#29218">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="29332.html">29332</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Contact Sam Cruise RAM disassembly 20150417</div>
<div class="copyright">&#169; 1986 Microsphere Computer Services Ltd (Contact Sam Cruise). &#169; 2015 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 4.3.</div>
</div>
</body>
</html>