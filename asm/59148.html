<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Contact Sam Cruise: Routine at 59148</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../microsphere.css" />
<link rel="stylesheet" type="text/css" href="../csc.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="59136.html">59136</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#59148">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="59366.html">59366</a></span></td>
</tr>
</table>
<div class="description">59148: Print a tile</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routines at <a class="link" href="26075.html">26075</a>, <a class="link" href="59406.html">59406</a>, <a class="link" href="59461.html">59461</a>, <a class="link" href="59516.html">59516</a>, <a class="link" href="59575.html">59575</a> and <a class="link" href="60032.html">60032</a>. Copies a background tile of the play area into the back buffer at <a class="link" href="40990.html">40990</a>, superimposes character sprite tiles and a foreground tile as appropriate, and then copies the resultant tile to the screen. Also sets the corresponding attribute byte.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Screen row number (0-19)</td>
</tr>
<tr>
<td class="register">L</td>
<td class="register-desc">Screen column number (0-31)</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59148"></a>59148</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">Put the screen coordinates onto the stack</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59149"></a>59149</td>
<td class="instruction">LD A,H</td>
<td class="comment-11" rowspan="11">Compute the corresponding display file address in <span class="register">HL</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59150"></a>59150</td>
<td class="instruction">AND 7</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59152"></a>59152</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59153"></a>59153</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59154"></a>59154</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59155"></a>59155</td>
<td class="instruction">ADD A,L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59156"></a>59156</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59157"></a>59157</td>
<td class="instruction">LD A,H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59158"></a>59158</td>
<td class="instruction">AND 24</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59160"></a>59160</td>
<td class="instruction">ADD A,64</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59162"></a>59162</td>
<td class="instruction">LD H,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59163"></a>59163</td>
<td class="instruction">EX (SP),HL</td>
<td class="comment-11" rowspan="1">Put the display file address onto the stack and get the screen coordinates back in <span class="register">HL</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59164"></a>59164</td>
<td class="instruction">LD DE,(32766)</td>
<td class="comment-11" rowspan="1"><span class="register">DE</span>=play area coordinates of the top-left corner of the screen</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59168"></a>59168</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-11" rowspan="1"><span class="register">HL</span>=play area coordinates of the tile to be printed</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59169"></a>59169</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">Push these coordinates onto the stack...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59170"></a>59170</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59171"></a>59171</td>
<td class="instruction">POP DE</td>
<td class="comment-11" rowspan="1">...and pop them into <span class="register">DE'</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59172"></a>59172</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="59173"></a>
<div class="comments">
<div class="paragraph">
In order to find the graphic data and attribute byte for the play area tile(s) to be printed at (X,Y), we need the T and T' values for that location; these values can be found in turn from the Z, Z' and Z'' values for the location.
</div>
<div class="paragraph">
The Z value (0&lt;=Z&lt;=101) for the play area location (X,Y) is found in byte INT(X/8) of page 184+INT(Y/6). Then the Z' value is found in byte Z of page <a class="link" href="48896.html">191</a>, and the Z'' value in byte 128+Z of page 184+X%8.
</div>
<div class="paragraph">
Z'' and bit 7-(X%8) of Z' determine the address, P, of the T value for the play area location (X,Y): Z'' is the LSB, and the MSB is either 160+2*(Y%6) or 172+2*(Y%6), depending on whether bit 7-(X%8) of Z' is reset or set. The address of the T' value is P+256.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59173"></a>59173</td>
<td class="instruction">LD A,H</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=Y, the play area y-coordinate (2-39)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59174"></a>59174</td>
<td class="instruction">LD D,183</td>
<td class="comment-11" rowspan="4">Set <span class="register">D</span>=184+INT(Y/6) (184-190)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59176"></a>59176</td>
<td class="instruction">INC D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59177"></a>59177</td>
<td class="instruction">SUB 6</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59179"></a>59179</td>
<td class="instruction">JR NC,59176</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59181"></a>59181</td>
<td class="instruction">ADD A,86</td>
<td class="comment-11" rowspan="1">80&lt;=<span class="register">A</span>&lt;=85</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59183"></a>59183</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=160, 162, 164, 166, 168 or 170</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59184"></a>59184</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1"><span class="register">B</span>=160+2*(Y%6)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59185"></a>59185</td>
<td class="instruction">LD A,L</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=X, the play area x-coordinate (0-255)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59186"></a>59186</td>
<td class="instruction">AND 248</td>
<td class="comment-11" rowspan="1">Keep only bits 3-7</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59188"></a>59188</td>
<td class="instruction">RRA</td>
<td class="comment-11" rowspan="3">Slide them down into bits 0-4; now <span class="register">A</span>=INT(X/8)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59189"></a>59189</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59190"></a>59190</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59191"></a>59191</td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1">Point <span class="register">DE</span> at the Z value for the play area location (X,Y)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59192"></a>59192</td>
<td class="instruction">LD A,L</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=X, the play area x-coordinate (0-255)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59193"></a>59193</td>
<td class="instruction">AND 7</td>
<td class="comment-11" rowspan="1">Keep only bits 0-2; now <span class="register">A</span>=X%8</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59195"></a>59195</td>
<td class="instruction">PUSH AF</td>
<td class="comment-11" rowspan="1">Save this value briefly</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59196"></a>59196</td>
<td class="instruction">ADD A,160</td>
<td class="comment-11" rowspan="1">160&lt;=<span class="register">A</span>&lt;=167</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59198"></a>59198</td>
<td class="instruction">LD H,A</td>
<td class="comment-11" rowspan="1"><span class="register">H</span>=160+(X%8)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59199"></a>59199</td>
<td class="instruction">LD L,21</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 21 of page 160+(X%8)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59201"></a>59201</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-11" rowspan="1">Now <span class="register">C</span>=128 (if X%8=0), 64, 32, 16, 8, 4, 2, or 1 (if X%8=7)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59202"></a>59202</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=Z (value of byte INT(X/8) of page 184+INT(Y/6))</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59203"></a>59203</td>
<td class="instruction">LD L,A</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=Z (0-101)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59204"></a>59204</td>
<td class="instruction">LD H,191</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the table of Z' values at <a class="link" href="48896.html">48896</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59206"></a>59206</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=Z' (0, 1, 3, 7, 14, 31, 128, 134, 199, 215, 240, 252, or 255)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59207"></a>59207</td>
<td class="instruction">AND C</td>
<td class="comment-11" rowspan="1">Is bit 7-(X%8) of Z' set?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59208"></a>59208</td>
<td class="instruction">JR Z,59214</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59210"></a>59210</td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="3">Otherwise set <span class="register">B</span>=172+2*(Y%6)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59211"></a>59211</td>
<td class="instruction">ADD A,12</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59213"></a>59213</td>
<td class="instruction">LD B,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59214"></a>59214</td>
<td class="instruction">SET 7,L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=128+Z (128-229)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59216"></a>59216</td>
<td class="instruction">POP AF</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=X%8</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59217"></a>59217</td>
<td class="instruction">ADD A,184</td>
<td class="comment-11" rowspan="2"><span class="register">H</span>=184+X%8</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59219"></a>59219</td>
<td class="instruction">LD H,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59220"></a>59220</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">C</span>=Z'' (value of byte 128+Z of page 184+X%8)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59221"></a>59221</td>
<td class="instruction">SET 5,E</td>
<td class="comment-11" rowspan="1"><span class="register">E</span>=32+INT(X/8)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59223"></a>59223</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=value of byte 32+INT(X/8) of page 184+INT(Y/6)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59224"></a>59224</td>
<td class="instruction">LD L,A</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=attribute byte address LSB (0-27)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59225"></a>59225</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=32+INT(X/8)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59226"></a>59226</td>
<td class="instruction">XOR 96</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=64+INT(X/8)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59228"></a>59228</td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1">Point <span class="register">DE</span> at the window flags for the play area location (X,Y)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59229"></a>59229</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=T (value of byte Z'' of page 160+2*(Y%6) or 172+2*(Y%6))</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="59230"></a>
<div class="comments">
<div class="paragraph">
<span id="tValue" /> We have collected the T value for the play area location (X,Y). Bits 7 and 6 of T have the following meanings:
</div>
<div class="paragraph">
<table class="default">
<tr>
<th>Value</th>
<th>Meaning</th>
</tr>
<tr>
<td class="centre">11</td>
<td>This location has a background tile and a transparent foreground tile</td>
</tr>
<tr>
<td class="centre">10</td>
<td>This location has a blank background tile and a transparent foreground tile (used by windows and house number signs)</td>
</tr>
<tr>
<td class="centre">01</td>
<td>This location has an opaque foreground tile only (characters with a z-coordinate of 1 will appear behind it)</td>
</tr>
<tr>
<td class="centre">00</td>
<td>This location has a background tile only (characters with a z-coordinate of 1 will appear in front of it)</td>
</tr>
</table>
</div>
<div class="paragraph">
When bits 7 and 6 of T are both set (11), bits 2-5 of T and bit 7 of T' indicate the LSB of the address of the background tile's graphic data; the MSB is always 128. The LSBs of the addresses of the graphic data for the two half-tiles that make up the foreground tile are derived from bits 0-6 of T'; the MSBs are always 128.
</div>
<div class="paragraph">
When bit 7 of T is set and bit 6 is reset (10), bits 3-5 are unused, and bit 2 is set only if the right-hand window of a pair is at this location. The LSBs of the addresses of the graphic data for the two half-tiles that make up the foreground tile are derived from T' (0-31) and the window flags; the MSBs are always 128.
</div>
<div class="paragraph">
When bit 7 of T is reset, bit 5 is unused (always reset), and bits 2-4 indicate the MSB of the address of the tile's graphic data (128, 136, 144, 152 or 160); the LSB is equal to T'.
</div>
<div class="paragraph">
Finally, bits 1 and 0 of T indicate the MSB of the address of the tile's attribute byte (168, 169, 170 or 171); the LSB (0-27, already collected in <span class="register">L</span> at this point) is found in byte 32+INT(X/8) of page 184+INT(Y/6).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59230"></a>59230</td>
<td class="instruction">AND 3</td>
<td class="comment-11" rowspan="1">Keep only bits 0 and 1 of T</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59232"></a>59232</td>
<td class="instruction">ADD A,168</td>
<td class="comment-11" rowspan="1">168&lt;=<span class="register">A</span>&lt;=171</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59234"></a>59234</td>
<td class="instruction">LD H,A</td>
<td class="comment-11" rowspan="1">168&lt;=<span class="register">H</span>&lt;=171</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59235"></a>59235</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=play area tile attribute byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59236"></a>59236</td>
<td class="instruction">LD (43038),A</td>
<td class="comment-11" rowspan="1">Save it at <a class="link" href="43038.html">43038</a> for later retrieval</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59239"></a>59239</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=T</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59240"></a>59240</td>
<td class="instruction">INC B</td>
<td class="comment-11" rowspan="1"><span class="register">B</span>=161+2*(Y%6) or 173+2*(Y%6); now <span class="register">BC</span> points at the T' value</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59241"></a>59241</td>
<td class="instruction">RLCA</td>
<td class="comment-11" rowspan="1">Does this play area location have a background tile and a foreground tile?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59242"></a>59242</td>
<td class="instruction">JR NC,59324</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="59244"></a>
<div class="comments">
<div class="paragraph">
The play area location under consideration has a background tile and a foreground tile.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59244"></a>59244</td>
<td class="instruction">BIT 7,A</td>
<td class="comment-11" rowspan="1">Is there a window or a house number sign here?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59246"></a>59246</td>
<td class="instruction">JR NZ,59268</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="59248"></a>
<div class="comments">
<div class="paragraph">
There is a window or a house number sign at this location.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59248"></a>59248</td>
<td class="instruction">CALL <a class="link" href="63450.html">63450</a></td>
<td class="comment-11" rowspan="1">Collect the window flags</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59251"></a>59251</td>
<td class="instruction">JR Z,59259</td>
<td class="comment-11" rowspan="1">Jump unless we are dealing with the right-hand window of a pair</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59253"></a>59253</td>
<td class="instruction">AND 35</td>
<td class="comment-11" rowspan="1">Keep only bits 5 (light indicator), 1 and 0 (decoration indicator) of the window flags</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59255"></a>59255</td>
<td class="instruction">ADD A,96</td>
<td class="comment-11" rowspan="1">Set bit 7 if the light is off (i.e. copy bit 5 into bit 7)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59257"></a>59257</td>
<td class="instruction">RRCA</td>
<td class="comment-11" rowspan="2">Move bits 1 and 0 (decoration indicator) into bits 7 and 6, and the light indicator back into bit 5</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59258"></a>59258</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59259"></a>59259</td>
<td class="instruction">AND 224</td>
<td class="comment-11" rowspan="1">Keep only bits 5 (light indicator), 6 and 7 (decoration indicator) of the window flags</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59261"></a>59261</td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1">Copy these bits to <span class="register">E</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59262"></a>59262</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=T' (0-31 for window tiles and house number sign tiles)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59263"></a>59263</td>
<td class="instruction">OR E</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=foreground tile identifier</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59264"></a>59264</td>
<td class="instruction">LD L,159</td>
<td class="comment-11" rowspan="1">Use tile 159 in page 128 (which is blank) as the background tile</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59266"></a>59266</td>
<td class="instruction">JR 59281</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="59268"></a>
<div class="comments">
<div class="paragraph">
There is no window or house number sign at this location, and it has a background tile and a transparent foreground tile.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59268"></a>59268</td>
<td class="instruction">AND 120</td>
<td class="comment-11" rowspan="2">Keep only bits 2-5 of T</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59270"></a>59270</td>
<td class="instruction">RRA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59271"></a>59271</td>
<td class="instruction">SCF</td>
<td class="comment-11" rowspan="2">Shift bits 2-5 into bits 1-4 and set bit 7</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59272"></a>59272</td>
<td class="instruction">RRA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59273"></a>59273</td>
<td class="instruction">LD L,A</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=background tile reference (even number &gt;= 128)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59274"></a>59274</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=T'</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59275"></a>59275</td>
<td class="instruction">RLCA</td>
<td class="comment-11" rowspan="1">Is bit 7 of T' set?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59276"></a>59276</td>
<td class="instruction">JR NC,59279</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59278"></a>59278</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1">Increment the background tile reference (to an odd number &gt;= 129)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59279"></a>59279</td>
<td class="instruction">SCF</td>
<td class="comment-11" rowspan="2"><span class="register">A</span>=T' with bit 7 set</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59280"></a>59280</td>
<td class="instruction">RRA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59281"></a>59281</td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1"><span class="register">E</span>=foreground tile identifier</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59282"></a>59282</td>
<td class="instruction">LD H,128</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the background tile graphic data</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="59284"></a>
<div class="comments">
<div class="paragraph">
Now <span class="register">HL</span> holds the base address of the background tile graphic data.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59284"></a>59284</td>
<td class="instruction">PUSH DE</td>
<td class="comment-11" rowspan="1">Save the foreground tile identifier (in <span class="register">E</span>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59285"></a>59285</td>
<td class="instruction">CALL <a class="link" href="59136.html">59136</a></td>
<td class="comment-11" rowspan="1">Copy the background tile into the back buffer at <a class="link" href="40990.html">40990</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59288"></a>59288</td>
<td class="instruction">LD A,1</td>
<td class="comment-11" rowspan="2">Superimpose sprite tiles for characters who are indoors (z=1)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59290"></a>59290</td>
<td class="instruction">CALL <a class="link" href="59635.html#59640">59640</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59293"></a>59293</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1">Restore the foreground tile identifier to <span class="register">C</span></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="59294"></a>
<div class="comments">
<div class="paragraph">
Now we superimpose the foreground tile. The 16 graphic and mask bytes for the foreground tile are found in two groups of 8 bytes in pages 128-135.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59294"></a>59294</td>
<td class="instruction">LD B,192</td>
<td class="comment-11" rowspan="1">The LSB of the first group of 8 bytes is found in page <a class="link" href="49152.html">192</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59296"></a>59296</td>
<td class="instruction">LD DE,40990</td>
<td class="comment-11" rowspan="1">Point <span class="register">DE</span> at the back buffer at <a class="link" href="40990.html">40990</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59299"></a>59299</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=LSB of the first group of 8 bytes</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59300"></a>59300</td>
<td class="instruction">LD L,A</td>
<td class="comment-11" rowspan="1">Copy the LSB to <span class="register">L</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59301"></a>59301</td>
<td class="instruction">LD H,128</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the first byte (a graphic byte) in the group</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59303"></a>59303</td>
<td class="instruction">LD B,4</td>
<td class="comment-11" rowspan="1">There are 4 pairs of bytes per group</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59305"></a>59305</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=back buffer byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59306"></a>59306</td>
<td class="instruction">OR (HL)</td>
<td class="comment-11" rowspan="1">OR on the graphic byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59307"></a>59307</td>
<td class="instruction">INC H</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the corresponding mask byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59308"></a>59308</td>
<td class="instruction">AND (HL)</td>
<td class="comment-11" rowspan="1">AND on the mask byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59309"></a>59309</td>
<td class="instruction">INC H</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the next graphic byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59310"></a>59310</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-11" rowspan="1">Replace the back buffer byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59311"></a>59311</td>
<td class="instruction">INC D</td>
<td class="comment-11" rowspan="1">Point <span class="register">DE</span> at the next back buffer byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59312"></a>59312</td>
<td class="instruction">DJNZ 59305</td>
<td class="comment-11" rowspan="1">Jump back until all 8 bytes have been done</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59314"></a>59314</td>
<td class="instruction">LD B,193</td>
<td class="comment-11" rowspan="1">The LSB of the second group of 8 bytes is found in page <a class="link" href="49408.html">193</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59316"></a>59316</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=LSB of the second group of 8 bytes</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59317"></a>59317</td>
<td class="instruction">INC C</td>
<td class="comment-11" rowspan="1">Set the zero flag if we've just done the second group</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59318"></a>59318</td>
<td class="instruction">LD C,255</td>
<td class="comment-11" rowspan="1">Signal: the second group is next</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59320"></a>59320</td>
<td class="instruction">JR NZ,59300</td>
<td class="comment-11" rowspan="1">Jump back until both groups have been done</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59322"></a>59322</td>
<td class="instruction">JR 59342</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="59324"></a>
<div class="comments">
<div class="paragraph">
The play area location under consideration has only one tile: either a background tile (if bit 6 of T is reset), or an opaque foreground tile (bit 6 of T set).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59324"></a>59324</td>
<td class="instruction">AND 184</td>
<td class="comment-11" rowspan="1">Keep only bits 3-5 and 7 (bits 2-4 and 6 of T)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59326"></a>59326</td>
<td class="instruction">RLCA</td>
<td class="comment-11" rowspan="1">Copy bit 6 of T into the carry flag</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59327"></a>59327</td>
<td class="instruction">PUSH AF</td>
<td class="comment-11" rowspan="1">Save the carry flag</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59328"></a>59328</td>
<td class="instruction">SCF</td>
<td class="comment-11" rowspan="2">Now <span class="register">A</span> has bit 7 set, and a copy of bits 2-4 of T in bits 3-5</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59329"></a>59329</td>
<td class="instruction">RRA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59330"></a>59330</td>
<td class="instruction">LD H,A</td>
<td class="comment-11" rowspan="1"><span class="register">H</span>=128, 136, 144, 152 or 160</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59331"></a>59331</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=T'</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59332"></a>59332</td>
<td class="instruction">LD L,A</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the tile graphic data</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59333"></a>59333</td>
<td class="instruction">CALL <a class="link" href="59136.html">59136</a></td>
<td class="comment-11" rowspan="1">Copy the tile into the back buffer at <a class="link" href="40990.html">40990</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59336"></a>59336</td>
<td class="instruction">POP AF</td>
<td class="comment-11" rowspan="1">Restore the carry flag</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59337"></a>59337</td>
<td class="instruction">LD A,1</td>
<td class="comment-11" rowspan="2">Superimpose sprite tiles for characters who are indoors (z=1) if we're dealing with a background tile</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59339"></a>59339</td>
<td class="instruction">CALL NC,<a class="link" href="59635.html#59640">59640</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="59342"></a>
<div class="comments">
<div class="paragraph">
Now we can superimpose sprite tiles for characters who are in the foreground.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="59342"></a>59342</td>
<td class="instruction">LD A,2</td>
<td class="comment-11" rowspan="2">Superimpose sprite tiles for characters who are between a building and the sidewalk (z=2), and then for characters who are on the sidewalk or road (z=4)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59344"></a>59344</td>
<td class="instruction">CALL <a class="link" href="59635.html">59635</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="59347"></a>
<div class="comments">
<div class="paragraph">
The tile in the back buffer is now ready to be drawn.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59347"></a>59347</td>
<td class="instruction">POP DE</td>
<td class="comment-11" rowspan="1"><span class="register">DE</span>=display file address</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59348"></a>59348</td>
<td class="instruction">LD C,E</td>
<td class="comment-11" rowspan="1"><span class="register">C</span>=corresponding attribute file address LSB</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59349"></a>59349</td>
<td class="instruction">LD A,D</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=display file address MSB (64, 72 or 80)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59350"></a>59350</td>
<td class="instruction">LD HL,40990</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the back buffer containing the tile to be drawn</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59353"></a>59353</td>
<td class="instruction">RRCA</td>
<td class="comment-11" rowspan="4"><span class="register">A</span>=88, 89 or 90</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59354"></a>59354</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59355"></a>59355</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59356"></a>59356</td>
<td class="instruction">ADD A,80</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59358"></a>59358</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1">Point <span class="register">BC</span> at the appropriate byte of the attribute file</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59359"></a>59359</td>
<td class="instruction">LD A,(43038)</td>
<td class="comment-11" rowspan="1">Collect the attribute byte saved earlier at <a class="link" href="43038.html">43038</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59362"></a>59362</td>
<td class="instruction">LD (BC),A</td>
<td class="comment-11" rowspan="1">Copy it to the attribute file</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="59363"></a>59363</td>
<td class="instruction">JP <a class="link" href="59136.html#59139">59139</a></td>
<td class="comment-11" rowspan="1">Copy the tile to the display file</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="59136.html">59136</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#59148">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="59366.html">59366</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Contact Sam Cruise RAM disassembly 20140614</div>
<div class="copyright">&#169; 1986 Microsphere Computer Services Ltd (Contact Sam Cruise). &#169; 2014 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://pyskool.ca/?page_id=177">SkoolKit</a> 4.0.</div>
</div>
</body>
</html>