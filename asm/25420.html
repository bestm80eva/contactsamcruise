<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Contact Sam Cruise: Routine at 25420</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../csc.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="Contact Sam Cruise" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="25395.html">25395</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#25420">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="25539.html">25539</a></span></td>
</tr>
</table>
<div class="description">25420: Control a banknote</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the command list at <a class="link" href="64888.html">64888</a>. Calculates and sets the banknote's next animatory state and location. If the banknote is far enough off-screen to the left or right, it will be moved to a location just off-screen to the left.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">228 or 229 (banknote)</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="25420"></a>25420</td>
<td class="instruction">LD A,(32745)</td>
<td class="comment-11" rowspan="1"><a class="link" href="32745.html">32745</a> holds Sam's object inventory</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25423"></a>25423</td>
<td class="instruction">RLCA</td>
<td class="comment-11" rowspan="2">Has Sam got the hook (bit 6 set)?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25424"></a>25424</td>
<td class="instruction">RLCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25425"></a>25425</td>
<td class="instruction">JR NC,25434</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="25427"></a>
<div class="comments">
<div class="paragraph">
Sam's got the hook; we bring this banknote out of service so that its character buffer is available for use by the hook when it's thrown. However, the banknote is not removed from view, which is a <a class="link" href="../reference/bugs.html#frozenFiver">bug</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25427"></a>25427</td>
<td class="instruction">CALL <a class="link" href="59848.html">59848</a></td>
<td class="comment-11" rowspan="1">Update the SRB for the banknote's current animatory state and location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25430"></a>25430</td>
<td class="instruction">CALL <a class="link" href="63409.html">63409</a></td>
<td class="comment-11" rowspan="1">Change the banknote's primary command routine address to <a class="link" href="25420.html#25433">25433</a> (below)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25433"></a>25433</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="25434"></a>
<div class="comments">
<div class="paragraph">
This entry point is used by the command list at <a class="link" href="64886.html">64886</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="25434"></a>25434</td>
<td class="instruction">LD L,10</td>
<td class="comment-11" rowspan="2">Collect byte 10 of the banknote's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25436"></a>25436</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25437"></a>25437</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Reset the zero flag if Sam has just landed on this banknote</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25438"></a>25438</td>
<td class="instruction">LD (HL),0</td>
<td class="comment-11" rowspan="1">Set byte 10 to zero</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25440"></a>25440</td>
<td class="instruction">JR NZ,25461</td>
<td class="comment-11" rowspan="1">Jump if Sam has just landed on this banknote</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="25442"></a>
<div class="comments">
<div class="paragraph">
First we check whether the banknote is far off-screen to the left or right.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25442"></a>25442</td>
<td class="instruction">LD L,1</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 1 of the banknote's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25444"></a>25444</td>
<td class="instruction">LD A,(32766)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=X (the x-coordinate of the leftmost column of the play area on screen)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25447"></a>25447</td>
<td class="instruction">SUB 12</td>
<td class="comment-11" rowspan="1">Is X=0 or 8?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25449"></a>25449</td>
<td class="instruction">JR C,25454</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25451"></a>25451</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="1">Is the banknote's x-coordinate greater than X-12?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25452"></a>25452</td>
<td class="instruction">JR NC,25461</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="25454"></a>25454</td>
<td class="instruction">ADD A,60</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=X+48</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25456"></a>25456</td>
<td class="instruction">JR C,25477</td>
<td class="comment-11" rowspan="1">Jump if X=0, 8, 208, 216 or 224</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25458"></a>25458</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="1">Is the banknote's x-coordinate greater than X+48?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25459"></a>25459</td>
<td class="instruction">JR NC,25477</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="25461"></a>
<div class="comments">
<div class="paragraph">
The banknote is off-screen to the left by at least 12 x-coordinates, or it's off-screen to the right by at least 17 x-coordinates, or it's just been landed on by Sam. Time to reinitialise its animatory state and location.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="25461"></a>25461</td>
<td class="instruction">CALL <a class="link" href="59848.html">59848</a></td>
<td class="comment-11" rowspan="1">Update the SRB for the banknote's current animatory state and location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25464"></a>25464</td>
<td class="instruction">LD D,34</td>
<td class="comment-11" rowspan="1">Initialise the banknote's y-coordinate to 34</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25466"></a>25466</td>
<td class="instruction">LD A,(32766)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=X (the x-coordinate of the leftmost column of the play area on screen)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25469"></a>25469</td>
<td class="instruction">SUB 11</td>
<td class="comment-11" rowspan="1">Is X&gt;8?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25471"></a>25471</td>
<td class="instruction">JR NC,25474</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25473"></a>25473</td>
<td class="instruction">SBC A,A</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=255</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="25474"></a>25474</td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1"><span class="register">E</span>=255 (if X&lt;=8) or X-11</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25475"></a>25475</td>
<td class="instruction">JR 25480</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="25477"></a>
<div class="comments">
<div class="paragraph">
The banknote is on-screen or not far off it. Now we calculate the banknote's next animatory state and location.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="25477"></a>25477</td>
<td class="instruction">CALL <a class="link" href="59848.html">59848</a></td>
<td class="comment-11" rowspan="1">Update the SRB for the banknote's current animatory state and location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="25480"></a>25480</td>
<td class="instruction">PUSH AF</td>
<td class="comment-11" rowspan="1">Save the banknote's current animatory state briefly</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25481"></a>25481</td>
<td class="instruction">CALL <a class="link" href="61823.html">61823</a></td>
<td class="comment-11" rowspan="1">Get a random number in <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25484"></a>25484</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1">Copy it to <span class="register">C</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25485"></a>25485</td>
<td class="instruction">AND 136</td>
<td class="comment-11" rowspan="1">Keep only bits 3 and 7</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25487"></a>25487</td>
<td class="instruction">ADD A,62</td>
<td class="comment-11" rowspan="2"><span class="register">B</span>=<a class="link" href="../graphics/as.html#62">62</a>, <a class="link" href="../graphics/as.html#70">70</a>, <a class="link" href="../graphics/as.html#190">190</a>, or <a class="link" href="../graphics/as.html#198">198</a> (banknote animatory states)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25489"></a>25489</td>
<td class="instruction">LD B,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25490"></a>25490</td>
<td class="instruction">POP AF</td>
<td class="comment-11" rowspan="1">Restore the banknote's current animatory state to <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25491"></a>25491</td>
<td class="instruction">CP B</td>
<td class="comment-11" rowspan="1">Is it equal to <span class="register">B</span>?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25492"></a>25492</td>
<td class="instruction">JR Z,25480</td>
<td class="comment-11" rowspan="1">Jump back to generate another animatory state if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="25494"></a>
<div class="comments">
<div class="paragraph">
At this point <span class="register">B</span> holds the banknote's next animatory state. Now we calculate its next location.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25494"></a>25494</td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=banknote's next animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25495"></a>25495</td>
<td class="instruction">PUSH AF</td>
<td class="comment-11" rowspan="1">Save this briefly</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25496"></a>25496</td>
<td class="instruction">CALL <a class="link" href="60152.html#60164">60164</a></td>
<td class="comment-11" rowspan="1">Set the carry flag if the banknote is above the road (as opposed to the sidewalk)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25499"></a>25499</td>
<td class="instruction">ADC A,45</td>
<td class="comment-11" rowspan="2"><span class="register">A</span>=45 if the banknote is above the sidewalk, or 46 if it's above the road</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25501"></a>25501</td>
<td class="instruction">SUB E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25502"></a>25502</td>
<td class="instruction">SUB D</td>
<td class="comment-11" rowspan="1">Subtract the banknote's current y-coordinate (32-35); now <span class="register">A</span>=11+G, where G (-1&lt;=G&lt;=3) is the height of the banknote above the ground</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25503"></a>25503</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="5">Multiply this value by 5 and add 1 (<span class="register">A</span>=51, 56, 61, 66, or 71)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25504"></a>25504</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25505"></a>25505</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25506"></a>25506</td>
<td class="instruction">ADD A,B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25507"></a>25507</td>
<td class="instruction">INC A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25508"></a>25508</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">Save the banknote's character number</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25509"></a>25509</td>
<td class="instruction">LD L,A</td>
<td class="comment-11" rowspan="2">Point <span class="register">HL</span> at the entry in the banknote animation table at <a class="link" href="25395.html">25395</a> that corresponds to the banknote's height above the ground</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25510"></a>25510</td>
<td class="instruction">LD H,99</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25512"></a>25512</td>
<td class="instruction">LD A,C</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=random number generated earlier</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25513"></a>25513</td>
<td class="instruction">LD BC,1283</td>
<td class="comment-11" rowspan="1"><span class="register">B</span>=5 (number of bytes in the entry), <span class="register">C</span>=3</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="25516"></a>25516</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="4">Find the first byte in the entry that is greater than <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25517"></a>25517</td>
<td class="instruction">JR C,25522</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25519"></a>25519</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25520"></a>25520</td>
<td class="instruction">DJNZ 25516</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="25522"></a>25522</td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=0-5</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25523"></a>25523</td>
<td class="instruction">CP C</td>
<td class="comment-11" rowspan="1">Is <span class="register">A</span>&lt;3?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25524"></a>25524</td>
<td class="instruction">JR C,25528</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25526"></a>25526</td>
<td class="instruction">INC E</td>
<td class="comment-11" rowspan="1">Otherwise increment the banknote's x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25527"></a>25527</td>
<td class="instruction">SUB C</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=0-2</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="25528"></a>25528</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=0, 2 or 4</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25529"></a>25529</td>
<td class="instruction">JR Z,25532</td>
<td class="comment-11" rowspan="1">Jump if <span class="register">A</span>=0</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25531"></a>25531</td>
<td class="instruction">SUB C</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=-1 or 1</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="25532"></a>25532</td>
<td class="instruction">ADD A,D</td>
<td class="comment-11" rowspan="2">Add -1, 0 or 1 to the banknote's current y-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25533"></a>25533</td>
<td class="instruction">LD D,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25534"></a>25534</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Restore the banknote's character number to <span class="register">H</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25535"></a>25535</td>
<td class="instruction">POP AF</td>
<td class="comment-11" rowspan="1">Restore the banknote's next animatory state to <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25536"></a>25536</td>
<td class="instruction">JP <a class="link" href="59861.html">59861</a></td>
<td class="comment-11" rowspan="1">Update the banknote's animatory state and location and update the SRB</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="25395.html">25395</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#25420">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="25539.html">25539</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Contact Sam Cruise RAM disassembly 20150417</div>
<div class="copyright">&#169; 1986 Microsphere Computer Services Ltd (Contact Sam Cruise). &#169; 2015 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 4.3.</div>
</div>
</body>
</html>