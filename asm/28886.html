<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Contact Sam Cruise: Routine at 28886</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../microsphere.css" />
<link rel="stylesheet" type="text/css" href="../csc.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="28885.html">28885</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#28886">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="28940.html">28940</a></span></td>
</tr>
</table>
<div class="description">28886: Check whether a character is visible to passers-by</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a class="link" href="29218.html">29218</a>. Returns with the zero flag set if the character is not inside any building, or is in the stairwell of the police station or one of the apartment buildings, or is on the catwalk, or is on the roof of a building.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Character number (215-230)</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="28886"></a>28886</td>
<td class="instruction">LD L,4</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 4 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28888"></a>28888</td>
<td class="instruction">BIT 0,(HL)</td>
<td class="comment-11" rowspan="1">Is the character indoors?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28890"></a>28890</td>
<td class="instruction">RET Z</td>
<td class="comment-11" rowspan="1">Return with the zero flag set if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="28891"></a>
<div class="comments">
<div class="paragraph">
The character is indoors, so examine his location more precisely.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28891"></a>28891</td>
<td class="instruction">LD L,1</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 1 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28893"></a>28893</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=x (character's x-coordinate)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28894"></a>28894</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="2"><span class="register">A</span>=INT((x+1)/8)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28895"></a>28895</td>
<td class="instruction">AND 248</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28897"></a>28897</td>
<td class="instruction">CP 8</td>
<td class="comment-11" rowspan="2">Return if 7&lt;=x&lt;=14 (the character is in the stairwell of the apartment building at the far left of town)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28899"></a>28899</td>
<td class="instruction">RET Z</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28900"></a>28900</td>
<td class="instruction">CP 136</td>
<td class="comment-11" rowspan="2">Return if 135&lt;=x&lt;=142 (the character is in the stairwell of the police station)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28902"></a>28902</td>
<td class="instruction">RET Z</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28903"></a>28903</td>
<td class="instruction">CP 192</td>
<td class="comment-11" rowspan="2">Return if 191&lt;=x&lt;=198 (the character is in the stairwell of the apartment building next to no. 19)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28905"></a>28905</td>
<td class="instruction">RET Z</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28906"></a>28906</td>
<td class="instruction">CP 24</td>
<td class="comment-11" rowspan="2">Return if 23&lt;=x&lt;=30 (the character is on the catwalk)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28908"></a>28908</td>
<td class="instruction">RET Z</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="28909"></a>
<div class="comments">
<div class="paragraph">
The character is neither on the catwalk, nor in a stairwell that is visible from outside.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28909"></a>28909</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=x (the character's x-coordinate)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28910"></a>28910</td>
<td class="instruction">DEC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=0 (this should be 'INC L', so that <span class="register">HL</span> points at the character's y-coordinate)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28911"></a>28911</td>
<td class="instruction">CP 56</td>
<td class="comment-11" rowspan="2">Jump if x&lt;56 (the character is in no. 74 or the apartment building next to it)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28913"></a>28913</td>
<td class="instruction">JR C,28930</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28915"></a>28915</td>
<td class="instruction">CP 104</td>
<td class="comment-11" rowspan="2">Return with the zero flag reset if 56&lt;=x&lt;=103 (the character is in the hotel, whose roof is inaccessible)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28917"></a>28917</td>
<td class="instruction">RET C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28918"></a>28918</td>
<td class="instruction">CP 123</td>
<td class="comment-11" rowspan="2">Jump if 104&lt;=x&lt;=122 (the character is in no. 31)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28920"></a>28920</td>
<td class="instruction">JR C,28934</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28922"></a>28922</td>
<td class="instruction">CP 207</td>
<td class="comment-11" rowspan="2">Jump if 123&lt;=x&lt;=206 (the character is in the police station, no. 27 or the apartment building next to no. 19)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28924"></a>28924</td>
<td class="instruction">JR C,28930</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28926"></a>28926</td>
<td class="instruction">CP 222</td>
<td class="comment-11" rowspan="2">Jump if 207&lt;=x&lt;=221 (the character is in no. 19)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28928"></a>28928</td>
<td class="instruction">JR C,28934</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="28930"></a>
<div class="comments">
<div class="paragraph">
If we get here, then the character is in the apartment building at the far left of town, no. 74, the police station, no. 27, the apartment building next to no. 19, no. 17, or no. 15.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="28930"></a>28930</td>
<td class="instruction">LD A,8</td>
<td class="comment-11" rowspan="1">If the character's y-coordinate is greater than this, he's inside (as opposed to on the roof)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28932"></a>28932</td>
<td class="instruction">JR 28936</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="28934"></a>
<div class="comments">
<div class="paragraph">
If we get here, then the character is in no. 31 or no. 19.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="28934"></a>28934</td>
<td class="instruction">LD A,14</td>
<td class="comment-11" rowspan="1">If the character's y-coordinate is greater than this, he's inside (as opposed to on the roof)</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="28936"></a>
<div class="comments">
<div class="paragraph">
The next instruction is supposed to compare <span class="register">A</span> with the character's y-coordinate to see whether he's on the roof of a building (as opposed to inside it), but because of the erroneous 'DEC L' instruction above, it instead compares <span class="register">A</span> with the character's animatory state. This is a <a class="link" href="../reference/bugs.html#troubleHiding">bug</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="28936"></a>28936</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="1">Compare <span class="register">A</span> (8 or 14) with the character's animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28937"></a>28937</td>
<td class="instruction">RET C</td>
<td class="comment-11" rowspan="1">Return with the zero flag reset if <span class="register">A</span> is smaller</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28938"></a>28938</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="1">Set the zero flag (the character is visible)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28939"></a>28939</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="28885.html">28885</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#28886">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="28940.html">28940</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Contact Sam Cruise RAM disassembly 20140614</div>
<div class="copyright">&#169; 1986 Microsphere Computer Services Ltd (Contact Sam Cruise). &#169; 2014 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://pyskool.ca/?page_id=177">SkoolKit</a> 4.0.</div>
</div>
</body>
</html>