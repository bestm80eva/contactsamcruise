<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Contact Sam Cruise: Routine at 60812</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../csc.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="Contact Sam Cruise" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="60810.html">60810</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#60812">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="61186.html">61186</a></span></td>
</tr>
</table>
<div class="description">60812: Determine the next move a character should make to reach his destination</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routines at <a class="link" href="29361.html">29361</a>, <a class="link" href="31126.html">31126</a>, <a class="link" href="31362.html">31362</a> and <a class="link" href="62976.html">62976</a>. Returns with <span class="register">A</span> holding a value that indicates the next move the character should make (if any) to reach his destination.
</div>
<div class="paragraph">
<table class="default">
<tr>
<th colspan="1" rowspan="1"><span class="register">A</span></th>
<th colspan="1" rowspan="1">Meaning the character should...</th>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">0</td>
<td class="" colspan="1" rowspan="1">Do nothing (the character is already at his destination)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">1</td>
<td class="" colspan="1" rowspan="1">Go right</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">2</td>
<td class="" colspan="1" rowspan="1">Go left</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">3</td>
<td class="" colspan="1" rowspan="1">Go up</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">4</td>
<td class="" colspan="1" rowspan="1">Go down</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">5</td>
<td class="" colspan="1" rowspan="1">Open a door from the inside</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">6</td>
<td class="" colspan="1" rowspan="1">Knock on a door or use a key</td>
</tr>
</table>
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Character number (215-230)</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="60812"></a>60812</td>
<td class="instruction">CALL <a class="link" href="31808.html">31808</a></td>
<td class="comment-11" rowspan="1">Deal with the case where the character will soon be entering or leaving the hotel; otherwise return here</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60815"></a>60815</td>
<td class="instruction">LD L,13</td>
<td class="comment-11" rowspan="2">Initialise the location/destination indicator in byte 13 of the character's buffer to 0</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60817"></a>60817</td>
<td class="instruction">LD (HL),0</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60819"></a>60819</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Is the character on the sidewalk or the road?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60820"></a>60820</td>
<td class="instruction">JR NZ,60883</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60822"></a>60822</td>
<td class="instruction">DEC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=12</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60823"></a>60823</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=destination location identifier (see <a class="link" href="60726.html">60726</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60824"></a>60824</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Is the character's destination on the sidewalk or the road?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60825"></a>60825</td>
<td class="instruction">JR NZ,60842</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="60827"></a>
<div class="comments">
<div class="paragraph">
The next section of code deals with the case where the character can reach his destination simply by continuing to move left or right. The routine at <a class="link" href="31808.html">31808</a> re-enters here (from the opening CALL in this routine) if the character is on the front steps of the hotel, and his destination is on the first floor or the front steps of the hotel.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="60827"></a>60827</td>
<td class="instruction">LD L,10</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 10 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60829"></a>60829</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">E</span>=destination x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60830"></a>60830</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="1">Copy this to <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60831"></a>60831</td>
<td class="instruction">LD L,1</td>
<td class="comment-11" rowspan="2">Does the character's x-coordinate match the destination x-coordinate?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60833"></a>60833</td>
<td class="instruction">CP (HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60834"></a>60834</td>
<td class="instruction">LD A,0</td>
<td class="comment-11" rowspan="2">Return with <span class="register">A</span>=0 (do nothing) if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60836"></a>60836</td>
<td class="instruction">RET Z</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60837"></a>60837</td>
<td class="instruction">LD A,1</td>
<td class="comment-11" rowspan="2">Return with <span class="register">A</span>=1 (go right) if the character's x-coordinate is less than the destination x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60839"></a>60839</td>
<td class="instruction">RET NC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60840"></a>60840</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=2 (go left)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60841"></a>60841</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="60842"></a>
<div class="comments">
<div class="paragraph">
The character is on the sidewalk or the road, and his destination is somewhere other than the sidewalk or the road. Move the character left or right towards the building he's destined for, or make him go up a step if he's reached the front steps of the building.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="60842"></a>60842</td>
<td class="instruction">AND 240</td>
<td class="comment-11" rowspan="1">Keep only the region identifier bits (bits 4-7) of the destination</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60844"></a>60844</td>
<td class="instruction">RRCA</td>
<td class="comment-11" rowspan="3">Shift them into bits 1-4</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60845"></a>60845</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60846"></a>60846</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60847"></a>60847</td>
<td class="instruction">ADD A,150</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=152+2n (n=0-11, 13 or 14)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60849"></a>60849</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="2">Point <span class="register">BC</span> at the entry in the table of building entrance x-coordinates at <a class="link" href="65432.html">65432</a> that corresponds to the character's destination</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60850"></a>60850</td>
<td class="instruction">LD B,255</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60852"></a>60852</td>
<td class="instruction">LD L,1</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 1 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60854"></a>60854</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-11" rowspan="1">Pick up the lower x-coordinate of the building entrance</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60855"></a>60855</td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1">Copy it to <span class="register">E</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60856"></a>60856</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="1">Compare it with the character's x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60857"></a>60857</td>
<td class="instruction">LD A,L</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=1 (go right)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60858"></a>60858</td>
<td class="instruction">JR NZ,60865</td>
<td class="comment-11" rowspan="1">Jump unless the x-coordinates match</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60860"></a>60860</td>
<td class="instruction">DEC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=0</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60861"></a>60861</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-11" rowspan="1">Is the character facing right?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60863"></a>60863</td>
<td class="instruction">JR NZ,60877</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="60865"></a>60865</td>
<td class="instruction">RET NC</td>
<td class="comment-11" rowspan="1">Return with <span class="register">A</span>=1 (go right)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60866"></a>60866</td>
<td class="instruction">INC C</td>
<td class="comment-11" rowspan="2">Pick up the upper x-coordinate of the building entrance</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60867"></a>60867</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60868"></a>60868</td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1">Copy it to <span class="register">E</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60869"></a>60869</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="1">Compare it with the character's x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60870"></a>60870</td>
<td class="instruction">LD A,2</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=2 (go left)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60872"></a>60872</td>
<td class="instruction">RET NZ</td>
<td class="comment-11" rowspan="1">Return unless the x-coordinates match</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60873"></a>60873</td>
<td class="instruction">DEC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=0</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60874"></a>60874</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-11" rowspan="1">Is the character facing right?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60876"></a>60876</td>
<td class="instruction">RET NZ</td>
<td class="comment-11" rowspan="1">Return with <span class="register">A</span>=2 (go left) if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="60877"></a>60877</td>
<td class="instruction">LD L,13</td>
<td class="comment-11" rowspan="2">Set byte 13 of the character's buffer to 1 (indicating that the character is no longer on the sidewalk or the road, and is in the same region as his destination)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60879"></a>60879</td>
<td class="instruction">INC (HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60880"></a>60880</td>
<td class="instruction">LD A,3</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=3 (go up)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60882"></a>60882</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="60883"></a>
<div class="comments">
<div class="paragraph">
The character is on neither the sidewalk nor the road.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="60883"></a>60883</td>
<td class="instruction">INC (HL)</td>
<td class="comment-11" rowspan="1">Set byte 13 of the character's buffer to 1 (indicating that the character is on neither the sidewalk nor the road)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60884"></a>60884</td>
<td class="instruction">DEC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=12</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60885"></a>60885</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="1">Is the character on the fire escape of the apartment building next to no. 19?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60886"></a>60886</td>
<td class="instruction">JR NZ,60925</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="60888"></a>
<div class="comments">
<div class="paragraph">
The character is on the fire escape of the apartment building next to no. 19.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60888"></a>60888</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=destination location identifier (see <a class="link" href="60726.html">60726</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60889"></a>60889</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="1">Set the zero flag if the destination is on the fire escape</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60890"></a>60890</td>
<td class="instruction">SCF</td>
<td class="comment-11" rowspan="1">Set the carry flag: the character will go back up the fire escape (if his destination is not on the fire escape)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60891"></a>60891</td>
<td class="instruction">JR NZ,60900</td>
<td class="comment-11" rowspan="1">Jump if the destination is not on the fire escape</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60893"></a>60893</td>
<td class="instruction">DEC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=11</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60894"></a>60894</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character's destination y-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60895"></a>60895</td>
<td class="instruction">LD L,2</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 2 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60897"></a>60897</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="1">Does the character's y-coordinate match that of his destination?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60898"></a>60898</td>
<td class="instruction">JR Z,60827</td>
<td class="comment-11" rowspan="1">If so, move the character left or right towards his destination</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="60900"></a>60900</td>
<td class="instruction">PUSH AF</td>
<td class="comment-11" rowspan="1">Save the carry flag briefly</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60901"></a>60901</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">Save the character number briefly</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60902"></a>60902</td>
<td class="instruction">CALL <a class="link" href="60179.html">60179</a></td>
<td class="comment-11" rowspan="1">Obtain descriptors for the character's current location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60905"></a>60905</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Restore the character number to <span class="register">H</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60906"></a>60906</td>
<td class="instruction">POP AF</td>
<td class="comment-11" rowspan="1">Restore the carry flag</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60907"></a>60907</td>
<td class="instruction">LD A,C</td>
<td class="comment-11" rowspan="1">Copy the direction descriptor bits (see <a class="link" href="60179.html">60179</a>) to <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60908"></a>60908</td>
<td class="instruction">JR NC,60917</td>
<td class="comment-11" rowspan="1">Jump if the character's y-coordinate is less than that of his destination</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="60910"></a>
<div class="comments">
<div class="paragraph">
The character is on the fire escape of the apartment building next to no. 19, and his destination is either not on the fire escape, or somewhere further up the fire escape. In this case the character will go up the fire escape.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60910"></a>60910</td>
<td class="instruction">AND 16</td>
<td class="comment-11" rowspan="1">Set the zero flag unless the character is next to a step going up to the right</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60912"></a>60912</td>
<td class="instruction">LD A,3</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=3 (go up)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60914"></a>60914</td>
<td class="instruction">RET NZ</td>
<td class="comment-11" rowspan="1">Return if the character is next to a step going up to the right</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60915"></a>60915</td>
<td class="instruction">DEC A</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=2 (go left)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60916"></a>60916</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="60917"></a>
<div class="comments">
<div class="paragraph">
The character is on the fire escape of the apartment building next to no. 19, and his destination is somewhere further down the fire escape. In this case the character will go down the fire escape.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="60917"></a>60917</td>
<td class="instruction">AND 8</td>
<td class="comment-11" rowspan="1">Set the zero flag unless the character is next to a step going down to the left</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60919"></a>60919</td>
<td class="instruction">LD A,4</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=4 (go down)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60921"></a>60921</td>
<td class="instruction">RET NZ</td>
<td class="comment-11" rowspan="1">Return if the character is next to a step going down to the left</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60922"></a>60922</td>
<td class="instruction">LD A,1</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=1 (go right)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60924"></a>60924</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="60925"></a>
<div class="comments">
<div class="paragraph">
The character is on neither the sidewalk nor the road, nor on the fire escape of the apartment building next to no. 19.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="60925"></a>60925</td>
<td class="instruction">DEC A</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=identifier for the character's current location (see <a class="link" href="60726.html">60726</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60926"></a>60926</td>
<td class="instruction">LD B,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">B</span>=destination location identifier (see <a class="link" href="60726.html">60726</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60927"></a>60927</td>
<td class="instruction">INC B</td>
<td class="comment-11" rowspan="1">Is the destination on the fire escape of the apartment building next to no. 19?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60928"></a>60928</td>
<td class="instruction">JR NZ,60937</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60930"></a>60930</td>
<td class="instruction">CP 253</td>
<td class="comment-11" rowspan="1">Is the character on the rim of the roof of the apartment building next to no. 19?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60932"></a>60932</td>
<td class="instruction">JR NZ,60937</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60934"></a>60934</td>
<td class="instruction">LD A,4</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=4 (go down)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60936"></a>60936</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="60937"></a>
<div class="comments">
<div class="paragraph">
The character is on neither the sidewalk nor the road, nor on the fire escape of the apartment building next to no. 19; in addition, either his destination is not on the fire escape, or he is not on the rim of the roof of the apartment building next to no. 19.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="60937"></a>60937</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1"><span class="register">B</span>=identifier for the character's current location (see <a class="link" href="60726.html">60726</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60938"></a>60938</td>
<td class="instruction">AND 240</td>
<td class="comment-11" rowspan="1">Keep only the region identifier bits (bits 4-7)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60940"></a>60940</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1">Copy them to <span class="register">C</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60941"></a>60941</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">Collect the destination location identifier from byte 12 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60942"></a>60942</td>
<td class="instruction">AND 240</td>
<td class="comment-11" rowspan="1">Keep only the region identifier bits (bits 4-7)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60944"></a>60944</td>
<td class="instruction">CP C</td>
<td class="comment-11" rowspan="1">Is the character in the same region as his destination?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60945"></a>60945</td>
<td class="instruction">JP NZ,61100</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="60948"></a>
<div class="comments">
<div class="paragraph">
The character is in the same region as his destination.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60948"></a>60948</td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=identifier for the character's current location (see <a class="link" href="60726.html">60726</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60949"></a>60949</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="1">Compare it with the identifier for the character's destination</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60950"></a>60950</td>
<td class="instruction">JR NZ,60966</td>
<td class="comment-11" rowspan="1">Jump unless they match</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="60952"></a>
<div class="comments">
<div class="paragraph">
The character is in the same region as his destination, and also on the same floor.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60952"></a>60952</td>
<td class="instruction">LD L,11</td>
<td class="comment-11" rowspan="2"><span class="register">A</span>=character's destination y-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60954"></a>60954</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60955"></a>60955</td>
<td class="instruction">LD L,2</td>
<td class="comment-11" rowspan="2">Compare this with the character's current y-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60957"></a>60957</td>
<td class="instruction">CP (HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60958"></a>60958</td>
<td class="instruction">JP Z,60827</td>
<td class="comment-11" rowspan="1">If they match, move the character left or right towards his destination</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60961"></a>60961</td>
<td class="instruction">LD A,3</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=3 (go up)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60963"></a>60963</td>
<td class="instruction">RET C</td>
<td class="comment-11" rowspan="1">Return if the character's current y-coordinate is greater than that of his destination</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60964"></a>60964</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=4 (go down)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60965"></a>60965</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="60966"></a>
<div class="comments">
<div class="paragraph">
The character is in the same region as his destination, but either on a different floor, or outside the entrance to a shop or building when the destination is on the first floor inside (or vice versa).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="60966"></a>60966</td>
<td class="instruction">JR C,61036</td>
<td class="comment-11" rowspan="1">Jump if the character is below his destination</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60968"></a>60968</td>
<td class="instruction">AND 15</td>
<td class="comment-11" rowspan="1">Keep only bits 0-3 of the identifier for the character's current location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60970"></a>60970</td>
<td class="instruction">CP 4</td>
<td class="comment-11" rowspan="1">Is the character in a shop or on the first floor of a building (inside)?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60972"></a>60972</td>
<td class="instruction">JR NZ,61022</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60974"></a>60974</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=destination location identifier</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60975"></a>60975</td>
<td class="instruction">AND 15</td>
<td class="comment-11" rowspan="1">Keep only bits 0-3</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60977"></a>60977</td>
<td class="instruction">CP 2</td>
<td class="comment-11" rowspan="1">Set the zero flag if the destination is outside the entrance</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60979"></a>60979</td>
<td class="instruction">LD L,1</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 1 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60981"></a>60981</td>
<td class="instruction">JR NZ,61001</td>
<td class="comment-11" rowspan="1">Jump unless the destination is outside the entrance</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60983"></a>60983</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character's x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60984"></a>60984</td>
<td class="instruction">LD L,10</td>
<td class="comment-11" rowspan="2">Does it match the destination x-coordinate?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60986"></a>60986</td>
<td class="instruction">CP (HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60987"></a>60987</td>
<td class="instruction">JR NZ,60999</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60989"></a>60989</td>
<td class="instruction">PUSH DE</td>
<td class="comment-11" rowspan="1">Save the staircase endpoint x-coordinates briefly</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60990"></a>60990</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">Save the character number briefly</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60991"></a>60991</td>
<td class="instruction">CALL <a class="link" href="60179.html">60179</a></td>
<td class="comment-11" rowspan="1">Obtain descriptors for the character's current location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60994"></a>60994</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Restore the character number to <span class="register">H</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60995"></a>60995</td>
<td class="instruction">POP DE</td>
<td class="comment-11" rowspan="1">Restore the staircase endpoint x-coordinates to <span class="register">DE</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60996"></a>60996</td>
<td class="instruction">SUB 3</td>
<td class="comment-11" rowspan="1">Is the character standing at the (open) entrance to a building?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="60998"></a>60998</td>
<td class="instruction">RET Z</td>
<td class="comment-11" rowspan="1">Return with <span class="register">A</span>=0 (do nothing) if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="60999"></a>60999</td>
<td class="instruction">LD L,1</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 1 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="61001"></a>61001</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character's x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61002"></a>61002</td>
<td class="instruction">CP D</td>
<td class="comment-11" rowspan="1">Is the character standing at the top of the steps down to the sidewalk or the floor below?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61003"></a>61003</td>
<td class="instruction">JR NZ,61017</td>
<td class="comment-11" rowspan="1">If not, send the character towards the top of the steps</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61005"></a>61005</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">Save the character number briefly</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61006"></a>61006</td>
<td class="instruction">CALL <a class="link" href="60179.html">60179</a></td>
<td class="comment-11" rowspan="1">Obtain descriptors for the character's current location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61009"></a>61009</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Restore the character number to <span class="register">H</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61010"></a>61010</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="2">Is the character standing next to the open entrance to a building?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61011"></a>61011</td>
<td class="instruction">CP 4</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61013"></a>61013</td>
<td class="instruction">RET Z</td>
<td class="comment-11" rowspan="1">Return with <span class="register">A</span>=4 (go down) if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61014"></a>61014</td>
<td class="instruction">LD A,5</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=5 (open the door)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61016"></a>61016</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="61017"></a>61017</td>
<td class="instruction">LD A,1</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=1 (go right)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61019"></a>61019</td>
<td class="instruction">RET C</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61020"></a>61020</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=2 (go left)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61021"></a>61021</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="61022"></a>
<div class="comments">
<div class="paragraph">
Either the character is in the same region as his destination, but above it, and not in a shop or on the first floor of a building (inside); or the character is not in the same region as his destination, and is inside a building somewhere above the first floor.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="61022"></a>61022</td>
<td class="instruction">BIT 0,A</td>
<td class="comment-11" rowspan="1">Set the zero flag unless the character is on a staircase between floors</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61024"></a>61024</td>
<td class="instruction">LD A,4</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=4 (go down)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61026"></a>61026</td>
<td class="instruction">RET NZ</td>
<td class="comment-11" rowspan="1">Return if the character is on a staircase between floors</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61027"></a>61027</td>
<td class="instruction">LD L,1</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 1 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61029"></a>61029</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character's x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61030"></a>61030</td>
<td class="instruction">CP D</td>
<td class="comment-11" rowspan="1">Compare it with the x-coordinate of the top of the staircase leading down to the floor below</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61031"></a>61031</td>
<td class="instruction">LD A,4</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=4 (go down)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61033"></a>61033</td>
<td class="instruction">RET Z</td>
<td class="comment-11" rowspan="1">Return if the character is standing at the top of the staircase leading down to the floor below</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61034"></a>61034</td>
<td class="instruction">JR 61017</td>
<td class="comment-11" rowspan="1">Send the character towards the top of the staircase</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="61036"></a>
<div class="comments">
<div class="paragraph">
The character is in the same region as his destination, but below it.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="61036"></a>61036</td>
<td class="instruction">CALL <a class="link" href="28803.html">28803</a></td>
<td class="comment-11" rowspan="1">Deal with the case where the character is on the roof of the police station or the apartment building next to no. 19 and is destined for the edge of that roof; otherwise return here</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61039"></a>61039</td>
<td class="instruction">NOP</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61040"></a>61040</td>
<td class="instruction">JR NZ,61084</td>
<td class="comment-11" rowspan="1">Jump unless the character is standing outside the entrance to a shop or other building</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61042"></a>61042</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=destination location identifier (see <a class="link" href="60726.html">60726</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61043"></a>61043</td>
<td class="instruction">AND 15</td>
<td class="comment-11" rowspan="1">Keep only bits 0-3</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61045"></a>61045</td>
<td class="instruction">CP 4</td>
<td class="comment-11" rowspan="1">Set the zero flag if the destination is inside the shop or on the first floor of the building outside the entrance to which the character is standing</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61047"></a>61047</td>
<td class="instruction">LD L,1</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 1 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61049"></a>61049</td>
<td class="instruction">JR NZ,61067</td>
<td class="comment-11" rowspan="1">Jump unless the destination is inside the shop or on the first floor of the building outside the entrance to which the character is standing</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61051"></a>61051</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character's x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61052"></a>61052</td>
<td class="instruction">LD L,10</td>
<td class="comment-11" rowspan="2">Compare this with the destination x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61054"></a>61054</td>
<td class="instruction">CP (HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61055"></a>61055</td>
<td class="instruction">JR NZ,61067</td>
<td class="comment-11" rowspan="1">Jump unless they match</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61057"></a>61057</td>
<td class="instruction">PUSH DE</td>
<td class="comment-11" rowspan="1">Save the staircase endpoint x-coordinates briefly</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61058"></a>61058</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">Save the character number briefly</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61059"></a>61059</td>
<td class="instruction">CALL <a class="link" href="60179.html">60179</a></td>
<td class="comment-11" rowspan="1">Obtain descriptors for the character's current location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61062"></a>61062</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Restore the character number to <span class="register">H</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61063"></a>61063</td>
<td class="instruction">POP DE</td>
<td class="comment-11" rowspan="1">Restore the staircase endpoint x-coordinates to <span class="register">DE</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61064"></a>61064</td>
<td class="instruction">SUB 3</td>
<td class="comment-11" rowspan="1">Is the entrance next to which the character is standing open?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61066"></a>61066</td>
<td class="instruction">RET Z</td>
<td class="comment-11" rowspan="1">Return with <span class="register">A</span>=0 (do nothing) if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="61067"></a>61067</td>
<td class="instruction">NOP</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="61068"></a>
<div class="comments">
<div class="paragraph">
The character is standing outside the entrance to a shop or other building, and his destination is somewhere inside that shop or building.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61068"></a>61068</td>
<td class="instruction">CALL <a class="link" href="63749.html">63749</a></td>
<td class="comment-11" rowspan="1">Is the character standing at the right spot to enter the building or knock on the door?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61071"></a>61071</td>
<td class="instruction">JR NZ,61096</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61073"></a>61073</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">Save the character number briefly</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61074"></a>61074</td>
<td class="instruction">CALL <a class="link" href="60179.html">60179</a></td>
<td class="comment-11" rowspan="1">Obtain descriptors for the character's current location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61077"></a>61077</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Restore the character number to <span class="register">H</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61078"></a>61078</td>
<td class="instruction">CP 3</td>
<td class="comment-11" rowspan="1">Set the zero flag if the entrance is open</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61080"></a>61080</td>
<td class="instruction">JP <a class="link" href="63774.html">63774</a></td>
<td class="comment-11" rowspan="1">Check whether the character should enter the building or knock first</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61083"></a>61083</td>
<td class="instruction">NOP</td>
<td class="comment-11" rowspan="1">This instruction is never executed</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="61084"></a>
<div class="comments">
<div class="paragraph">
If we get here, then either the character is in the same region as his destination, but below it, and is not standing outside the entrance to a shop or other building; or the character is inside or on the roof of the police station and heading for no. 27 (or vice versa), and will be going via the roofs (instead of going down to the sidewalk).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="61084"></a>61084</td>
<td class="instruction">BIT 0,A</td>
<td class="comment-11" rowspan="1">Bit 0 of <span class="register">A</span> is set if the character is on a staircase</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61086"></a>61086</td>
<td class="instruction">LD A,3</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=3 (go up)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61088"></a>61088</td>
<td class="instruction">RET NZ</td>
<td class="comment-11" rowspan="1">Return if the character is on a staircase</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61089"></a>61089</td>
<td class="instruction">LD L,1</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 1 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61091"></a>61091</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character's x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61092"></a>61092</td>
<td class="instruction">CP E</td>
<td class="comment-11" rowspan="1">Compare this with the x-coordinate of the bottom of the staircase leading to the floor above</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61093"></a>61093</td>
<td class="instruction">LD A,3</td>
<td class="comment-11" rowspan="2">Return with <span class="register">A</span>=3 (go up) if the character is at the bottom of the staircase leading to the floor above</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61095"></a>61095</td>
<td class="instruction">RET Z</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="61096"></a>61096</td>
<td class="instruction">LD A,L</td>
<td class="comment-11" rowspan="2">Return with <span class="register">A</span>=1 (go right) if the character is to the left of either the bottom of the staircase leading to the floor above, or the correct spot at which to enter the building or knock on the door</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61097"></a>61097</td>
<td class="instruction">RET C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61098"></a>61098</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=2 (go left)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61099"></a>61099</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="61100"></a>
<div class="comments">
<div class="paragraph">
The character is not in the same region as his destination.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="61100"></a>61100</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="2">Set byte 13 of the character's buffer to 2 (to indicate that the character is not on the sidewalk or the road, and is heading for some region other than the one he's in)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61101"></a>61101</td>
<td class="instruction">INC (HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61102"></a>61102</td>
<td class="instruction">DEC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=12</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61103"></a>61103</td>
<td class="instruction">CP 96</td>
<td class="comment-11" rowspan="1">Is the character going to the police station?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61105"></a>61105</td>
<td class="instruction">JR Z,61118</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61107"></a>61107</td>
<td class="instruction">CP 112</td>
<td class="comment-11" rowspan="1">Is the character going to no. 27?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61109"></a>61109</td>
<td class="instruction">JR NZ,61130</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="61111"></a>
<div class="comments">
<div class="paragraph">
The character is going to no. 27, and is not in the same region as that building.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61111"></a>61111</td>
<td class="instruction">LD A,C</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=region identifier for the character's current location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61112"></a>61112</td>
<td class="instruction">CP 96</td>
<td class="comment-11" rowspan="1">Is the character inside or on the roof of the police station?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61114"></a>61114</td>
<td class="instruction">JR NZ,61130</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61116"></a>61116</td>
<td class="instruction">JR 61123</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="61118"></a>
<div class="comments">
<div class="paragraph">
The character is going to the police station, and is not in the same region as that building.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="61118"></a>61118</td>
<td class="instruction">LD A,C</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=region identifier for the character's current location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61119"></a>61119</td>
<td class="instruction">CP 112</td>
<td class="comment-11" rowspan="1">Is the character inside or on the roof of no. 27?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61121"></a>61121</td>
<td class="instruction">JR NZ,61130</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="61123"></a>
<div class="comments">
<div class="paragraph">
The character is either inside or on the roof of no. 27 and heading for the police station, or inside or on the roof of the police station and heading for no. 27.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="61123"></a>61123</td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=identifier for the character's current location (96-109 if it's the police station, or 112-125 if it's no. 27; see <a class="link" href="60726.html">60726</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61124"></a>61124</td>
<td class="instruction">ADD A,(HL)</td>
<td class="comment-11" rowspan="1">Add the destination location identifier</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61125"></a>61125</td>
<td class="instruction">CP 225</td>
<td class="comment-11" rowspan="1">Reset the carry flag if it would be quicker to go via the roofs than back down to the sidewalk</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61127"></a>61127</td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=identifier for the character's current location (see <a class="link" href="60726.html">60726</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61128"></a>61128</td>
<td class="instruction">JR NC,61084</td>
<td class="comment-11" rowspan="1">Jump if it would be quicker to go via the roofs than back down to the sidewalk</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="61130"></a>
<div class="comments">
<div class="paragraph">
The character is not in the same region as his destination. Figure out his next move towards the destination via the sidewalk.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="61130"></a>61130</td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=identifier for the character's current location (see <a class="link" href="60726.html">60726</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61131"></a>61131</td>
<td class="instruction">AND 15</td>
<td class="comment-11" rowspan="1">Keep only bits 0-3</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61133"></a>61133</td>
<td class="instruction">CP 4</td>
<td class="comment-11" rowspan="1">Is the character inside a shop or on the first floor of a building (inside)?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61135"></a>61135</td>
<td class="instruction">JP Z,60999</td>
<td class="comment-11" rowspan="1">If so, send him towards the entrance</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61138"></a>61138</td>
<td class="instruction">CP 1</td>
<td class="comment-11" rowspan="1">Is the character on the front steps of a building below the first floor?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61140"></a>61140</td>
<td class="instruction">JP NZ,61022</td>
<td class="comment-11" rowspan="1">If not, send the character towards the top of the staircase leading down to the floor below</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="61143"></a>
<div class="comments">
<div class="paragraph">
The character is not in the same region as his destination, and is on the front steps of a building below the first floor. Figure out which direction to take down the steps towards the destination.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61143"></a>61143</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">Save the character number briefly</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61144"></a>61144</td>
<td class="instruction">CALL <a class="link" href="60179.html">60179</a></td>
<td class="comment-11" rowspan="1">Obtain descriptors for the character's current location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61147"></a>61147</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Restore the character number to <span class="register">H</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61148"></a>61148</td>
<td class="instruction">LD L,1</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 1 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61150"></a>61150</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character's x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61151"></a>61151</td>
<td class="instruction">LD L,10</td>
<td class="comment-11" rowspan="2">Compare this with the character's destination x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61153"></a>61153</td>
<td class="instruction">CP (HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61154"></a>61154</td>
<td class="instruction">LD A,C</td>
<td class="comment-11" rowspan="1">Copy the direction descriptor bits (see <a class="link" href="60179.html">60179</a>) to <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61155"></a>61155</td>
<td class="instruction">JR NC,61173</td>
<td class="comment-11" rowspan="1">Jump if the character's x-coordinate is greater than or equal to the destination x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61157"></a>61157</td>
<td class="instruction">AND 4</td>
<td class="comment-11" rowspan="1">Is the character next to a step going down to the right?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61159"></a>61159</td>
<td class="instruction">JR NZ,61164</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="61161"></a>61161</td>
<td class="instruction">LD A,4</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=4 (go down)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61163"></a>61163</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="61164"></a>61164</td>
<td class="instruction">LD L,0</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 0 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61166"></a>61166</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-11" rowspan="1">Is the character facing right?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61168"></a>61168</td>
<td class="instruction">JR NZ,61161</td>
<td class="comment-11" rowspan="1">Jump if so to set <span class="register">A</span>=4 (go down)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61170"></a>61170</td>
<td class="instruction">LD A,1</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=1 (go right)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61172"></a>61172</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="61173"></a>61173</td>
<td class="instruction">AND 8</td>
<td class="comment-11" rowspan="1">Is the character standing next to a step going down to the left?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61175"></a>61175</td>
<td class="instruction">JR Z,61161</td>
<td class="comment-11" rowspan="1">Jump if not to set <span class="register">A</span>=4 (go down)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61177"></a>61177</td>
<td class="instruction">LD L,0</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 0 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61179"></a>61179</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-11" rowspan="1">Is the character facing left?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61181"></a>61181</td>
<td class="instruction">JR Z,61161</td>
<td class="comment-11" rowspan="1">Jump if so to set <span class="register">A</span>=4 (go down)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61183"></a>61183</td>
<td class="instruction">LD A,2</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=2 (go left)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="61185"></a>61185</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="60810.html">60810</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#60812">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="61186.html">61186</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Contact Sam Cruise RAM disassembly 20150417</div>
<div class="copyright">&#169; 1986 Microsphere Computer Services Ltd (Contact Sam Cruise). &#169; 2015 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 4.3.</div>
</div>
</body>
</html>